<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Nazmul Twisting Mill — Billing</title>
<link id="favico" rel="icon" href="assets/favicon.png" type="image/png" />
<!-- html2pdf bundle (contains html2canvas + jsPDF). Required for Download PDF in preview windows. -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<style>
  :root { --black:#000; --white:#fff; --muted:#666; --panel:#fafafa; --radius:12px; --pad:14px; }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--white);color:var(--black);padding:18px}
  .container{max-width:1150px;margin:0 auto}
  header{display:flex;gap:12px;align-items:center;margin-bottom:18px}
  .logo{width:60px;height:60px;border-radius:12px;background:var(--black);display:flex;align-items:center;justify-content:center;overflow:hidden}
  .logo img{max-width:44px;max-height:44px}
  header h1{margin:0;font-size:20px;font-weight:800}
  header p{margin:0;color:var(--muted);font-size:13px}

  .nav{display:flex;gap:8px;margin:14px 0 20px;flex-wrap:wrap}
  .nav button{background:var(--white);color:var(--black);border:1px solid var(--black);padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
  .nav button.active{background:var(--black);color:var(--white)}

  .page{display:none;padding:18px;border-radius:12px;border:1px solid #e6e6e6;background:var(--panel)}
  .page.active{display:block}
  h2{margin:0 0 8px 0;font-size:18px}
  p.lead{margin:0 0 14px 0;color:var(--muted)}
  .grid{display:grid;gap:12px}
  .card{background:var(--white);border-radius:12px;padding:12px;border:1px solid #ddd}
  .small{font-size:13px;color:var(--muted)}
  .muted{color:var(--muted)}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:10px;border:1px solid #eee;text-align:left;font-size:14px}
  th{background:#f6f6f6;font-weight:700;color:var(--muted);font-size:12px}
  .btn{display:inline-block;padding:8px 12px;border-radius:10px;border:1px solid var(--black);background:var(--black);color:var(--white);cursor:pointer;font-weight:700}
  .btn.secondary{background:var(--white);color:var(--black)}
  .btn.ghost{background:transparent;border:1px dashed #bbb;color:var(--black)}
  .btn.small{padding:6px 8px;font-size:13px;border-radius:8px}
  .right{text-align:right}
  .bold{font-weight:800}

  /* dashboard stats */
  .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px}
  @media (max-width:920px){ .stats-grid{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:560px){ .stats-grid{grid-template-columns:1fr} }

  /* weekly summary list */
  #weekly-summary-list .summary-item{border:1px solid #e6e6e6;padding:12px;border-radius:10px;background:#fff;margin-bottom:12px}
  .summary-top{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
  .summary-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

  /* bill summary page workers area */
  #bill-summary-workers-body .card{margin-bottom:10px}

  /* settings (black & white) */
  #settings{background:var(--white);border:1px solid var(--black)}
  .settings-shell{display:grid;grid-template-columns:1fr 420px;gap:18px}
  @media (max-width:980px){ .settings-shell{grid-template-columns:1fr} }
  .settings-panel{border:2px solid var(--black);background:var(--white);padding:18px;border-radius:14px}
  .settings-panel h3{margin:0 0 8px 0;font-size:16px;color:var(--black)}
  .settings-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
  @media (max-width:640px){ .settings-row{grid-template-columns:1fr} }
  label{display:block;font-weight:800;color:var(--black);margin-bottom:6px;font-size:13px}
  input[type="text"], input[type="number"], textarea, select{width:100%;padding:10px;border-radius:8px;border:1px solid var(--black);font-size:14px;background:transparent;color:var(--black)}
  textarea{min-height:64px;resize:vertical}
  .worker-card{border:1px solid var(--black);padding:12px;border-radius:10px;margin-bottom:12px;background:#fff}
  .worker-grid{display:grid;grid-template-columns:1fr 120px 120px;gap:8px;align-items:center}
  @media (max-width:760px){ .worker-grid{grid-template-columns:1fr 1fr 1fr} }
  @media (max-width:480px){ .worker-grid{grid-template-columns:1fr} }

  /* small helpers */
  .muted-small{color:var(--muted);font-size:13px}
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="logo"><img id="header-logo" src="assets/favicon.png" alt="logo" onerror="this.style.display='none'"></div>
    <div>
      <h1 id="header-name">Nazmul Twisting Mill</h1>
      <p class="small" id="header-contact">Old Bogura Road, Telkupi — (+880) 1766759293 — nazmul.fig@gmail.com</p>
    </div>
  </header>

  <nav class="nav" role="navigation" aria-label="Main">
    <button class="nav-btn active" data-page="dashboard">Dashboard</button>
    <button class="nav-btn" data-page="bill-summary">Bill Summary</button>
    <button class="nav-btn" data-page="settings">Settings</button>
  </nav>

  <!-- Dashboard (only Weekly Production Summary) -->
  <section id="dashboard" class="page active">
    <h2>Weekly Production Summary</h2>
    <p class="lead">Summaries created by saving a Bill Summary. Click a summary's View button to open its preview (then Download or Print from that page).</p>

    <div class="stats-grid">
      <div class="card">
        <div class="small">Revenue from Mohajon</div>
        <div id="summary-mohajon" class="bold" style="font-size:18px">৳0.00</div>
      </div>
      <div class="card">
        <div class="small">Total Worker Payments</div>
        <div id="summary-workers" class="bold" style="font-size:18px">৳0.00</div>
      </div>
      <div class="card">
        <div class="small">Total Expenses</div>
        <div id="summary-expenses" class="bold" style="font-size:18px">৳0.00</div>
      </div>
      <div class="card">
        <div class="small">Weekly Profit</div>
        <div id="summary-profit" class="bold" style="font-size:18px">৳0.00</div>
      </div>
    </div>

    <div id="weekly-summary-list"></div>
  </section>

  <!-- Bill Summary -->
  <section id="bill-summary" class="page">
    <h2>Bill Summary</h2>
    <p class="lead">Fill mohajon, workers' production and expenses. Click <strong>Save Summary</strong> to add it to Dashboard.</p>

    <div class="card" id="bill-summary-card">
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
        <img id="bs-logo" src="assets/favicon.png" alt="logo" style="width:72px;height:72px;border-radius:8px;object-fit:contain" onerror="this.style.display='none'"/>
        <div>
          <div style="font-weight:800" id="company-name-display">Nazmul Twisting Mill</div>
          <div class="muted-small" id="company-address-display">Old Bogura Road, Telkupi</div>
        </div>
      </div>

      <h3>Mohajon</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div>
          <label>Rate (৳/pound)</label>
          <input id="setting-mohajon-rate-inline" type="number" step="0.01" min="0">
        </div>
        <div>
          <label>Total Production (pounds)</label>
          <input id="setting-mohajon-totalproduction-inline" type="number" step="0.01" min="0">
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px">
        <div>
          <label>Money Given (৳)</label>
          <input id="setting-mohajon-moneygiven-inline" type="number" step="0.01" min="0">
        </div>
        <div>
          <label>Mohajon Name</label>
          <input id="setting-mohajon-name-inline" type="text">
        </div>
      </div>

      <h3 style="margin-top:12px">Workers Production</h3>
      <div id="bill-summary-workers-body"></div>

      <h3>Expenses</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
        <div><label>Electricity (৳)</label><input id="expense-electricity-inline" type="number" step="0.01" min="0"></div>
        <div><label>Maintenance (৳)</label><input id="expense-maintenance-inline" type="number" step="0.01" min="0"></div>
        <div><label>Other (৳)</label><input id="expense-other-inline" type="number" step="0.01" min="0"></div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="save-summary-btn">Save Summary</button>
        <button class="btn secondary" id="preview-summary-btn">Preview Summary (open)</button>
      </div>
    </div>
  </section>

  <!-- Settings -->
  <section id="settings" class="page">
    <h2>Settings</h2>
    <p class="lead">Company, Mohajon and Worker defaults. Black & white, responsive layout.</p>

    <div class="settings-shell">
      <div class="settings-panel">
        <h3>Company</h3>
        <label>Company Name</label><input id="setting-company-name" type="text">
        <label style="margin-top:8px">Address</label><textarea id="setting-company-address"></textarea>
        <div class="settings-row">
          <div><label>Phone</label><input id="setting-company-phone" type="text"></div>
          <div><label>Email</label><input id="setting-company-email" type="text"></div>
        </div>

        <hr style="border:none;border-top:1px solid var(--black);margin:12px 0">

        <h3>Mohajon Defaults</h3>
        <label>Company/Person</label><input id="setting-mohajon-company" type="text">
        <div class="settings-row">
          <div><label>Contact Name</label><input id="setting-mohajon-name" type="text"></div>
          <div><label>Phone</label><input id="setting-mohajon-phone" type="text"></div>
        </div>
        <label>Address</label><input id="setting-mohajon-address" type="text">
        <div class="settings-row">
          <div><label>Rate (৳/pound)</label><input id="setting-mohajon-rate" type="number" step="0.01" min="0"></div>
          <div><label>Total Production</label><input id="setting-mohajon-totalproduction" type="number" step="0.01" min="0"></div>
        </div>
        <label>Money Given (৳)</label><input id="setting-mohajon-moneygiven" type="number" step="0.01" min="0">
      </div>

      <div class="settings-panel">
        <h3>Workers</h3>
        <div id="worker-settings-list"></div>

        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn" id="save-data-btn">Save Data</button>
          <button class="btn secondary" id="reset-data-btn">Reset Data</button>
        </div>
        <div class="muted-small" style="margin-top:8px">Worker cards adapt to device width. To add/remove workers, edit the appState in the console or ask me to add UI controls.</div>
      </div>
    </div>
  </section>
</div>

<!-- delete modal -->
<div id="confirm-modal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:99">
  <div style="background:#fff;padding:16px;border-radius:10px;width:92%;max-width:520px;border:2px solid #000">
    <div id="confirm-text" style="font-weight:800">Confirm delete</div>
    <div id="confirm-subtext" style="margin-top:8px;color:#666">Type <strong>delete</strong> below to confirm.</div>
    <input id="confirm-input" style="margin-top:12px;padding:10px;border-radius:8px;border:1px solid #ddd;width:100%">
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="confirm-cancel" class="btn secondary">Cancel</button>
      <button id="confirm-ok" class="btn">Delete</button>
    </div>
  </div>
</div>

<script>
/* ------------------------------
   App state & persistence
   ------------------------------ */
const STORAGE_KEY = 'ntm_app_final_v1';
const defaultState = () => ({
  company: { name:'Nazmul Twisting Mill', address:'Old Bogura Road, Telkupi', phone:'(+880) 1766759293', email:'nazmul.fig@gmail.com', logo:'assets/favicon.png' },
  mohajon: { company:'Mohajon Co', name:'', address:'', phone:'', rate:0, totalProduction:0, moneyGiven:0 },
  workers: [
    { id:'w1', name:'Worker 1', designation:'Machine', rate:0, adjustment:0, bonus:0, phone:'', address:'' },
    { id:'w2', name:'Worker 2', designation:'Machine', rate:0, adjustment:0, bonus:0, phone:'', address:'' },
    { id:'w3', name:'Worker 3', designation:'Drum', rate:0, adjustment:0, bonus:0, phone:'', address:'' }
  ],
  productionInputs: {}, // keyed by worker id
  expenses: { electricity:0, maintenance:0, other:0 },
  summaries: [], // saved weekly summaries
  invoices: [],
  billingHistory: {}
});
let appState = loadState() || defaultState();

/* utilities */
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(appState)); renderAll(); }
function loadState(){ try{ const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : null }catch(e){ console.error(e); return null } }
function formatMoney(n){ return '৳' + Number(n||0).toFixed(2); }
function formatDateISO(d=new Date()){ return d.toLocaleDateString() + ' ' + d.toLocaleTimeString(); }
function getWeekPeriodText(d=new Date()){ const end=new Date(d); const start=new Date(d); start.setDate(end.getDate()-6); return `${start.toLocaleDateString()} - ${end.toLocaleDateString()}`; }
function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function uid(prefix='id'){ return prefix + '-' + Math.floor(100000 + Math.random()*900000); }

/* ------------------------------
   Preview builder + PDF download
   ------------------------------ */

/**
 * Build preview HTML string for a given summary object and view type.
 * viewType: 'summary' | 'invoice' | 'perworker' | 'receipt'
 */
function buildPreviewHtml(summaryObj, viewType){
  const company = summaryObj.company || appState.company || {};
  const mo = summaryObj.mohajon || appState.mohajon || {};
  const workers = summaryObj.workers || [];
  // minimal CSS used inside preview window
  const css = `
    body{margin:0;font-family:Arial,Helvetica,sans-serif;color:#000;background:#fff}
    .controls{position:sticky;top:0;background:#fff;padding:10px;display:flex;gap:10px;align-items:center;border-bottom:1px solid #eee;z-index:20}
    .btn{padding:8px 12px;border-radius:8px;border:1px solid #000;background:#000;color:#fff;cursor:pointer;font-weight:700}
    .btn.secondary{background:#fff;color:#000}
    .container{padding:18px}
    .header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
    .logo{width:72px;height:72px;object-fit:contain;border-radius:8px}
    h1{margin:0;font-size:20px}
    .meta{color:#444;font-size:13px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border:1px solid #ddd;font-size:13px}
    th{background:#f6f6f6;font-weight:700}
    .page-break{page-break-after:always}
  `;

  // Build body depending on viewType
  let bodyHtml = '';
  if(viewType === 'summary'){
    bodyHtml += `<div><strong>Period:</strong> ${escapeHtml(summaryObj.period || '')}</div>`;
    bodyHtml += `<h3>Mohajon</h3>
      <table><thead><tr><th>Rate</th><th>Production</th><th>Bill</th><th>Money Given</th><th>Due</th></tr></thead>
      <tbody><tr>
        <td class="right">${formatMoney(mo.rate||0)}</td>
        <td class="right">${Number(mo.totalProduction||0).toFixed(2)}</td>
        <td class="right">${formatMoney((mo.rate||0)*(mo.totalProduction||0))}</td>
        <td class="right">${formatMoney(mo.moneyGiven||0)}</td>
        <td class="right">${formatMoney((mo.rate||0)*(mo.totalProduction||0) - (mo.moneyGiven||0))}</td>
      </tr></tbody></table>`;

    bodyHtml += `<h3 style="margin-top:12px">Workers</h3>
      <table><thead><tr><th>Worker</th><th>Role</th><th>Pounds</th><th>Rate</th><th>Bill</th><th>Adjustment</th><th>Bonus</th><th>Final</th></tr></thead><tbody>`;
    for(const w of workers){
      bodyHtml += `<tr><td>${escapeHtml(w.name)}</td><td>${escapeHtml(w.designation||'')}</td><td class="right">${Number(w.pounds||0).toFixed(2)}</td><td class="right">${formatMoney(w.rate)}</td><td class="right">${formatMoney(w.bill)}</td><td class="right">${formatMoney(w.adjustment)}</td><td class="right">${formatMoney(w.bonus)}</td><td class="right">${formatMoney(w.total)}</td></tr>`;
    }
    bodyHtml += `</tbody><tfoot><tr><th colspan="7" style="text-align:right">Workers Subtotal</th><th class="right">${formatMoney(summaryObj.totals.payments)}</th></tr></tfoot></table>`;

    bodyHtml += `<h3 style="margin-top:12px">Expenses</h3>
      <table><thead><tr><th>Electricity</th><th>Maintenance</th><th>Other</th><th>Total</th></tr></thead>
      <tbody><tr><td class="right">${formatMoney(summaryObj.expenses.electricity||0)}</td><td class="right">${formatMoney(summaryObj.expenses.maintenance||0)}</td><td class="right">${formatMoney(summaryObj.expenses.other||0)}</td><td class="right">${formatMoney(summaryObj.totals.expenses|| ((summaryObj.expenses.electricity||0)+(summaryObj.expenses.maintenance||0)+(summaryObj.expenses.other||0)))}</td></tr></tbody></table>`;

    bodyHtml += `<h3 style="margin-top:12px">Summary</h3>
      <table><thead><tr><th>Income</th><th>Payments</th><th>Expenses</th><th>Net</th></tr></thead>
      <tbody><tr><td class="right">${formatMoney(summaryObj.totals.income)}</td><td class="right">${formatMoney(summaryObj.totals.payments)}</td><td class="right">${formatMoney(summaryObj.totals.expenses)}</td><td class="right">${formatMoney(summaryObj.totals.net)}</td></tr></tbody></table>`;
  } else if(viewType === 'invoice'){
    bodyHtml += `<div><strong>Invoice:</strong> ${escapeHtml(summaryObj.id||'')}</div>`;
    bodyHtml += `<table><thead><tr><th>Worker</th><th>Role</th><th>Pounds</th><th>Rate</th><th>Bill</th><th>Adjustment</th><th>Bonus</th><th>Total</th></tr></thead><tbody>`;
    for(const w of workers){
      bodyHtml += `<tr><td>${escapeHtml(w.name)}</td><td>${escapeHtml(w.designation||'')}</td><td class="right">${Number(w.pounds||0).toFixed(2)}</td><td class="right">${formatMoney(w.rate)}</td><td class="right">${formatMoney(w.bill)}</td><td class="right">${formatMoney(w.adjustment)}</td><td class="right">${formatMoney(w.bonus)}</td><td class="right">${formatMoney(w.total)}</td></tr>`;
    }
    bodyHtml += `</tbody><tfoot><tr><th colspan="7" style="text-align:right">Total Payments</th><th class="right">${formatMoney(summaryObj.totals.payments)}</th></tr></tfoot></table>`;
  } else if(viewType === 'perworker'){
    // one page per worker
    for(const w of workers){
      bodyHtml += `<div class="page-break">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><div style="font-weight:800">${escapeHtml(w.name)}</div><div style="color:#444">${escapeHtml(w.designation||'')}</div></div>
          <div style="text-align:right">${escapeHtml(summaryObj.period||'')}</div>
        </div>
        <div style="height:8px"></div>
        <table><thead><tr><th>Designation</th><th>Rate</th><th>Production</th><th>Bill</th></tr></thead><tbody>
        <tr><td>${escapeHtml(w.designation||'')}</td><td class="right">${formatMoney(w.rate)}</td><td class="right">${Number(w.pounds||0).toFixed(2)}</td><td class="right">${formatMoney(w.bill)}</td></tr>
        <tr><td colspan="3">Adjustment</td><td class="right">${formatMoney(w.adjustment)}</td></tr>
        <tr><td colspan="3">Bonus</td><td class="right">${formatMoney(w.bonus)}</td></tr>
        <tr><th colspan="3" style="text-align:right">Total</th><th class="right">${formatMoney(w.total)}</th></tr>
        </tbody></table>
      </div>`;
    }
  } else if(viewType === 'receipt'){
    const total = summaryObj.totals && summaryObj.totals.payments;
    bodyHtml += `<div style="text-align:center"><h2>Receipt</h2><div style="font-size:13px">Receipt No: <strong>RCPT-${uid('')}</strong></div></div>`;
    bodyHtml += `<div style="display:flex;justify-content:space-between;margin-top:12px"><div><strong>From (Mohajon)</strong><div style="margin-top:6px">${escapeHtml(summaryObj.mohajon.company || summaryObj.mohajon.name || '')}</div></div><div style="text-align:right"><strong>Received By</strong><div style="margin-top:6px">${escapeHtml(company.name||'')}</div><div style="margin-top:6px">${formatMoney(total)}</div></div></div>`;
  }

  // Final preview html with controls + content
  const previewHtml = `
    <!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Preview — ${escapeHtml(summaryObj.id||'Summary')}</title>
    <style>${css}</style>
    </head><body>
    <div class="controls">
      <button id="downloadPdf" class="btn">Download PDF</button>
      <button id="printBtn" class="btn secondary">Print</button>
      <button id="closeBtn" class="btn secondary">Close</button>
      <div style="flex:1"></div>
      <div style="font-size:13px;color:#444">${escapeHtml(summaryObj.date||'')}</div>
    </div>

    <div class="container">
      <div class="header">
        <div style="display:flex;gap:12px;align-items:center">
          <img class="logo" src="${escapeHtml(company.logo||'assets/favicon.png')}" onerror="this.style.display='none'">
          <div>
            <h1>${escapeHtml(company.name||'')}</h1>
            <div class="meta">${escapeHtml(company.address||'')} • ${escapeHtml(company.phone||'')}</div>
          </div>
        </div>
      </div>

      <div style="height:8px"></div>
      ${bodyHtml}
      <div style="height:20px"></div>
      <div style="font-size:12px;color:#666">Generated: ${escapeHtml(formatDateISO())}</div>
    </div>

    <script>
      // ensure html2pdf is available (the parent page already loads it, but just in case)
      function ensureHtml2pdf(cb){
        if(window.html2pdf) return cb();
        var s=document.createElement('script'); s.src='https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js';
        s.onload = cb; s.onerror = cb; document.head.appendChild(s);
      }
      document.getElementById('printBtn').addEventListener('click', ()=> window.print());
      document.getElementById('closeBtn').addEventListener('click', ()=> window.close());
      document.getElementById('downloadPdf').addEventListener('click', ()=> {
        ensureHtml2pdf(function(){
          try {
            const element = document.querySelector('.container');
            const opt = {
              margin: [10,10,10,10],
              filename: '${escapeHtml((summaryObj.id||'summary') + '.pdf')}',
              image: { type: 'jpeg', quality: 0.98 },
              html2canvas: { scale: 2, useCORS:true },
              jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().from(element).set(opt).save();
          } catch(e) { alert('PDF export failed: ' + (e && e.message)); }
        });
      });
    </script>
    </body></html>
  `;
  return previewHtml;
}

/**
 * Open a preview window for a summary object (may be saved or live).
 * viewType: 'summary' | 'invoice' | 'perworker' | 'receipt'
 */
function openPreviewWindow(summaryObj, viewType){
  const previewHtml = buildPreviewHtml(summaryObj, viewType);
  const win = window.open('', '_blank', 'noopener');
  if(!win) { alert('Popup blocked. Allow popups for this site to preview files.'); return; }
  win.document.open();
  win.document.write(previewHtml);
  win.document.close();
}

/* ------------------------------
   Render & UI wiring
   ------------------------------ */

/* Navigation */
document.querySelectorAll('.nav-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.getElementById(btn.dataset.page).classList.add('active');
    if(btn.dataset.page === 'bill-summary') populateBillSummaryInputs();
    if(btn.dataset.page === 'settings') populateSettingsForm();
  });
});

/* Apply header */
function applyHeader(){
  const c = appState.company || {};
  document.getElementById('header-name').textContent = c.name || '';
  document.getElementById('header-contact').textContent = `${c.address||''} — ${c.phone||''} — ${c.email||''}`;
  const img = document.getElementById('header-logo'); if(img) img.src = c.logo || 'assets/favicon.png';
}
applyHeader();

/* Render DB */
function renderAll(){
  applyHeader();
  renderStats();
  renderDashboardSummaries();
  populateWorkerSettingsList();
}

/* Stats */
function renderStats(){
  const mohajonAmt = Number(appState.mohajon.moneyGiven || 0);
  const totalWorkersPaid = computeWorkersTotalPaid();
  const expensesTotal = (appState.expenses.electricity||0) + (appState.expenses.maintenance||0) + (appState.expenses.other||0);
  const profit = mohajonAmt - totalWorkersPaid - expensesTotal;
  document.getElementById('summary-mohajon').textContent = formatMoney(mohajonAmt);
  document.getElementById('summary-workers').textContent = formatMoney(totalWorkersPaid);
  document.getElementById('summary-expenses').textContent = formatMoney(expensesTotal);
  document.getElementById('summary-profit').textContent = formatMoney(profit);
}

/* Dashboard: summaries list */
function renderDashboardSummaries(){
  const container = document.getElementById('weekly-summary-list');
  container.innerHTML = '';
  if(!appState.summaries || appState.summaries.length === 0){
    container.innerHTML = '<div class="card">No weekly summaries yet. Create one from <strong>Bill Summary</strong>.</div>';
    return;
  }
  appState.summaries.forEach((s, idx)=>{
    const el = document.createElement('div');
    el.className = 'summary-item';
    el.innerHTML = `
      <div class="summary-top">
        <div>
          <div class="bold">${escapeHtml(s.id||'')}</div>
          <div class="muted-small">${escapeHtml(s.date||'')} • ${escapeHtml(s.period||'')}</div>
        </div>
        <div class="right bold">${formatMoney(s.totals && s.totals.payments)}</div>
      </div>
      <div class="summary-actions">
        <button class="btn small" data-idx="${idx}" data-type="summary">View Bill Summary</button>
        <button class="btn small secondary" data-idx="${idx}" data-type="invoice">View Workers Invoice</button>
        <button class="btn small secondary" data-idx="${idx}" data-type="perworker">View Per-Worker Invoice</button>
        <button class="btn small secondary" data-idx="${idx}" data-type="receipt">View Receipt</button>
        <button class="btn small ghost" data-idx="${idx}" data-type="delete">Delete</button>
      </div>
    `;
    container.appendChild(el);
  });

  // attach handlers
  container.querySelectorAll('button').forEach(b=>{
    b.addEventListener('click', ()=>{
      const idx = parseInt(b.dataset.idx, 10);
      const type = b.dataset.type;
      const s = appState.summaries[idx];
      if(!s) return alert('Summary not found');
      if(type === 'delete'){ confirmDeleteSavedSummary(idx); return; }
      // open preview accordingly
      const viewMap = { summary:'summary', invoice:'invoice', perworker:'perworker', receipt:'receipt' };
      openPreviewWindow(s, viewMap[type] || 'summary');
    });
  });
}

/* compute workers total */
function computeWorkersTotalPaid(){
  let total = 0;
  for(const w of appState.workers){
    const pounds = Number(appState.productionInputs[w.id] || 0);
    const earnings = pounds * Number(w.rate || 0);
    total += (earnings - Number(w.adjustment || 0) + Number(w.bonus || 0));
  }
  return total;
}

/* ------------------------------
   Bill Summary inputs (inline) + Save Summary
   ------------------------------ */

/* populate bill summary inputs from appState */
function populateBillSummaryInputs(){
  document.getElementById('company-name-display').textContent = appState.company.name || '';
  document.getElementById('bs-logo').src = appState.company.logo || 'assets/favicon.png';

  // mohajon inline (prefill defaults)
  document.getElementById('setting-mohajon-rate-inline').value = appState.mohajon.rate || '';
  document.getElementById('setting-mohajon-totalproduction-inline').value = appState.mohajon.totalProduction || '';
  document.getElementById('setting-mohajon-moneygiven-inline').value = appState.mohajon.moneyGiven || '';
  document.getElementById('setting-mohajon-name-inline').value = appState.mohajon.name || '';

  // expenses inline
  document.getElementById('expense-electricity-inline').value = appState.expenses.electricity || '';
  document.getElementById('expense-maintenance-inline').value = appState.expenses.maintenance || '';
  document.getElementById('expense-other-inline').value = appState.expenses.other || '';

  // workers inputs
  const body = document.getElementById('bill-summary-workers-body');
  body.innerHTML = '';
  appState.workers.forEach((w, idx)=>{
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <div style="flex:1"><label style="font-weight:700">Name</label><input class="bs-w-name" type="text" value="${escapeHtml(w.name)}"></div>
        <div style="width:160px"><label style="font-weight:700">Designation</label><input class="bs-w-role" type="text" value="${escapeHtml(w.designation)}"></div>
        <div style="width:140px"><label style="font-weight:700">Rate (৳)</label><input class="bs-w-rate" type="number" step="0.01" value="${Number(w.rate)||''}"></div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
        <div style="width:160px"><label>Production (pounds)</label><input class="bs-w-pounds" type="number" step="0.01" value="${Number(appState.productionInputs[w.id]||0)||''}"></div>
        <div style="width:120px"><label>Adjustment</label><input class="bs-w-adjust" type="number" step="0.01" value="${Number(w.adjustment)||''}"></div>
        <div style="width:120px"><label>Bonus</label><input class="bs-w-bonus" type="number" step="0.01" value="${Number(w.bonus)||''}"></div>
      </div>
    `;
    body.appendChild(card);
  });
}

/* Save summary (creates saved summary + invoice and billing history) */
document.getElementById('save-summary-btn').addEventListener('click', ()=>{
  // read inline inputs
  const moRate = parseFloat(document.getElementById('setting-mohajon-rate-inline').value) || 0;
  const moTotalProd = parseFloat(document.getElementById('setting-mohajon-totalproduction-inline').value) || 0;
  const moMoney = parseFloat(document.getElementById('setting-mohajon-moneygiven-inline').value) || 0;
  const moName = document.getElementById('setting-mohajon-name-inline').value || appState.mohajon.company || '';

  const expElec = parseFloat(document.getElementById('expense-electricity-inline').value) || 0;
  const expMaint = parseFloat(document.getElementById('expense-maintenance-inline').value) || 0;
  const expOther = parseFloat(document.getElementById('expense-other-inline').value) || 0;

  const workerCards = Array.from(document.querySelectorAll('#bill-summary-workers-body .card'));
  const workersList = [];
  let workersSubtotal = 0;
  workerCards.forEach((card, idx)=>{
    const name = card.querySelector('.bs-w-name').value || ('Worker ' + (idx+1));
    const designation = card.querySelector('.bs-w-role').value || '';
    const rate = parseFloat(card.querySelector('.bs-w-rate').value) || 0;
    const pounds = parseFloat(card.querySelector('.bs-w-pounds').value) || 0;
    const adjustment = parseFloat(card.querySelector('.bs-w-adjust').value) || 0;
    const bonus = parseFloat(card.querySelector('.bs-w-bonus').value) || 0;
    const bill = rate * pounds;
    const total = bill - adjustment + bonus;
    workersSubtotal += total;
    const wid = appState.workers[idx] && appState.workers[idx].id ? appState.workers[idx].id : uid('w');
    appState.productionInputs[wid] = pounds;
    workersList.push({ id:wid, name, designation, pounds, rate, bill, adjustment, bonus, total });
  });

  const expTotal = expElec + expMaint + expOther;
  const income = moMoney;
  const net = income - workersSubtotal - expTotal;

  const summary = {
    id: 'BS-' + uid(''),
    date: formatDateISO(),
    period: getWeekPeriodText(),
    company: {...appState.company},
    mohajon: { company: moName, name: moName, rate: moRate, totalProduction: moTotalProd, moneyGiven: moMoney, address: appState.mohajon.address || '', phone: appState.mohajon.phone || '' },
    workers: workersList,
    expenses: { electricity: expElec, maintenance: expMaint, other: expOther },
    totals: { income, payments: workersSubtotal, expenses: expTotal, net }
  };

  // save summary
  appState.summaries = appState.summaries || [];
  appState.summaries.unshift(summary);

  // create invoice entry
  const invoice = { id: 'INV-' + uid(''), date: summary.date, period: summary.period, total: summary.totals.payments, workers: summary.workers.map(w => ({ ...w })) };
  appState.invoices = appState.invoices || [];
  appState.invoices.unshift(invoice);

  // billing history per worker
  invoice.workers.forEach(w => {
    appState.billingHistory[w.id] = appState.billingHistory[w.id] || [];
    appState.billingHistory[w.id].unshift({ date: invoice.date, pounds: w.pounds, bill: w.bill, adjustment: w.adjustment, bonus: w.bonus, total: w.total, invoiceId: invoice.id });
  });

  // update state convenience
  appState.mohajon.rate = moRate; appState.mohajon.totalProduction = moTotalProd; appState.mohajon.moneyGiven = moMoney;
  appState.expenses.electricity = expElec; appState.expenses.maintenance = expMaint; appState.expenses.other = expOther;

  saveState();
  // go to Dashboard to show summary
  document.querySelector('[data-page="dashboard"]').click();
});

/* Preview (live) */
document.getElementById('preview-summary-btn').addEventListener('click', ()=>{
  const live = buildLiveSummaryFromInputs();
  openPreviewWindow(live, 'summary');
});

/* Build live summary without saving */
function buildLiveSummaryFromInputs(){
  const moRate = parseFloat(document.getElementById('setting-mohajon-rate-inline').value) || 0;
  const moTotalProd = parseFloat(document.getElementById('setting-mohajon-totalproduction-inline').value) || 0;
  const moMoney = parseFloat(document.getElementById('setting-mohajon-moneygiven-inline').value) || 0;
  const moName = document.getElementById('setting-mohajon-name-inline').value || appState.mohajon.company || '';

  const expElec = parseFloat(document.getElementById('expense-electricity-inline').value) || 0;
  const expMaint = parseFloat(document.getElementById('expense-maintenance-inline').value) || 0;
  const expOther = parseFloat(document.getElementById('expense-other-inline').value) || 0;

  const workerCards = Array.from(document.querySelectorAll('#bill-summary-workers-body .card'));
  const workersList = []; let workersSubtotal = 0;
  workerCards.forEach((card, idx) => {
    const name = card.querySelector('.bs-w-name').value || ('Worker ' + (idx+1));
    const designation = card.querySelector('.bs-w-role').value || '';
    const rate = parseFloat(card.querySelector('.bs-w-rate').value) || 0;
    const pounds = parseFloat(card.querySelector('.bs-w-pounds').value) || 0;
    const adjustment = parseFloat(card.querySelector('.bs-w-adjust').value) || 0;
    const bonus = parseFloat(card.querySelector('.bs-w-bonus').value) || 0;
    const bill = rate * pounds;
    const total = bill - adjustment + bonus;
    workersSubtotal += total;
    const wid = appState.workers[idx] && appState.workers[idx].id ? appState.workers[idx].id : uid('w');
    workersList.push({ id:wid, name, designation, pounds, rate, bill, adjustment, bonus, total });
  });

  const expTotal = expElec + expMaint + expOther;
  const income = moMoney; const net = income - workersSubtotal - expTotal;
  return {
    id: 'LIVE-' + uid(''),
    date: formatDateISO(), period: getWeekPeriodText(),
    company: {...appState.company},
    mohajon: { company: moName, name: moName, rate: moRate, totalProduction: moTotalProd, moneyGiven: moMoney },
    workers: workersList,
    expenses: { electricity: expElec, maintenance: expMaint, other: expOther },
    totals: { income, payments: workersSubtotal, expenses: expTotal, net }
  };
}

/* ------------------------------
   Settings: populate, save, worker UI
   ------------------------------ */

function populateSettingsForm(){
  document.getElementById('setting-company-name').value = appState.company.name || '';
  document.getElementById('setting-company-address').value = appState.company.address || '';
  document.getElementById('setting-company-phone').value = appState.company.phone || '';
  document.getElementById('setting-company-email').value = appState.company.email || '';

  document.getElementById('setting-mohajon-company').value = appState.mohajon.company || '';
  document.getElementById('setting-mohajon-name').value = appState.mohajon.name || '';
  document.getElementById('setting-mohajon-phone').value = appState.mohajon.phone || '';
  document.getElementById('setting-mohajon-address').value = appState.mohajon.address || '';
  document.getElementById('setting-mohajon-rate').value = appState.mohajon.rate || '';
  document.getElementById('setting-mohajon-totalproduction').value = appState.mohajon.totalProduction || '';
  document.getElementById('setting-mohajon-moneygiven').value = appState.mohajon.moneyGiven || '';

  populateWorkerSettingsList();
}

function populateWorkerSettingsList(){
  const el = document.getElementById('worker-settings-list'); el.innerHTML = '';
  appState.workers.forEach((w, idx) => {
    const card = document.createElement('div'); card.className = 'worker-card';
    card.innerHTML = `
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <div style="flex:1"><label>Name</label><input class="ws-name" type="text" value="${escapeHtml(w.name)}"></div>
        <div style="width:120px"><label>Rate</label><input class="ws-rate" type="number" step="0.01" value="${Number(w.rate)||''}"></div>
        <div style="width:120px"><label>Adjustment</label><input class="ws-adjust" type="number" step="0.01" value="${Number(w.adjustment)||''}"></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <div style="flex:1"><label>Designation</label><input class="ws-role" type="text" value="${escapeHtml(w.designation||'')}"></div>
        <div style="width:140px"><label>Bonus</label><input class="ws-bonus" type="number" step="0.01" value="${Number(w.bonus)||''}"></div>
      </div>
    `;
    el.appendChild(card);
  });
}

/* save settings */
document.getElementById('save-data-btn').addEventListener('click', ()=>{
  appState.company.name = document.getElementById('setting-company-name').value || appState.company.name;
  appState.company.address = document.getElementById('setting-company-address').value || appState.company.address;
  appState.company.phone = document.getElementById('setting-company-phone').value || appState.company.phone;
  appState.company.email = document.getElementById('setting-company-email').value || appState.company.email;

  appState.mohajon.company = document.getElementById('setting-mohajon-company').value || appState.mohajon.company;
  appState.mohajon.name = document.getElementById('setting-mohajon-name').value || appState.mohajon.name;
  appState.mohajon.phone = document.getElementById('setting-mohajon-phone').value || appState.mohajon.phone;
  appState.mohajon.address = document.getElementById('setting-mohajon-address').value || appState.mohajon.address;
  appState.mohajon.rate = parseFloat(document.getElementById('setting-mohajon-rate').value) || 0;
  appState.mohajon.totalProduction = parseFloat(document.getElementById('setting-mohajon-totalproduction').value) || 0;
  appState.mohajon.moneyGiven = parseFloat(document.getElementById('setting-mohajon-moneygiven').value) || 0;

  const cards = Array.from(document.querySelectorAll('#worker-settings-list .worker-card'));
  cards.forEach((card, idx)=>{
    const w = appState.workers[idx];
    if(!w) return;
    w.name = card.querySelector('.ws-name').value || w.name;
    w.rate = parseFloat(card.querySelector('.ws-rate').value) || 0;
    w.adjustment = parseFloat(card.querySelector('.ws-adjust').value) || 0;
    w.designation = card.querySelector('.ws-role').value || w.designation;
    w.bonus = parseFloat(card.querySelector('.ws-bonus').value) || 0;
  });

  saveState();
  alert('Settings saved');
});

/* reset */
document.getElementById('reset-data-btn').addEventListener('click', ()=>{
  if(!confirm('Reset all data to defaults? This will remove saved summaries and settings.')) return;
  appState = defaultState();
  saveState();
  location.reload();
});

/* ------------------------------
   Delete saved summary (typed confirmation)
   ------------------------------ */
function confirmDeleteSavedSummary(index){
  const modal = document.getElementById('confirm-modal');
  modal.style.display = 'flex';
  const input = document.getElementById('confirm-input'); input.value = '';
  document.getElementById('confirm-text').textContent = 'Delete summary?';
  document.getElementById('confirm-subtext').innerHTML = 'Type <strong>delete</strong> below to confirm.';
  function cleanup(){ modal.style.display='none'; ok.removeEventListener('click', okHandler); cancel.removeEventListener('click', cancelHandler); }
  function okHandler(){ if((input.value||'').trim().toLowerCase() === 'delete'){ cleanup(); appState.summaries.splice(index,1); saveState(); } else { alert('Type \"delete\" to confirm'); input.focus(); } }
  function cancel(){ cleanup(); }
  const ok = document.getElementById('confirm-ok'); const cancelBtn = document.getElementById('confirm-cancel');
  ok.addEventListener('click', okHandler);
  cancelBtn.addEventListener('click', cancel);
}

/* ------------------------------
   Initialize
   ------------------------------ */
renderAll();
populateBillSummaryInputs();
applyHeader();

/* Expose state for debugging in console if you want */
window._appState = appState;
</script>
</body>
</html>
