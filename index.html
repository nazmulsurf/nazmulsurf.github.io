<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Billing & Production — Nazmul Twisting Mill</title>
<link id="favico" rel="icon" href="assets/favicon.png" type="image/png" />
<style>
  :root{
    --bg: #ffffff; --panel:#f7f7f7; --text:#0b0b0b; --muted:#6b6b6b; --accent:#000;
    --radius:10px; --btn-radius:8px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);padding:18px}
  .container{max-width:1150px;margin:0 auto}
  header{background:var(--accent);color:#fff;padding:18px;border-radius:var(--radius);margin-bottom:16px;display:flex;gap:12px;align-items:center;justify-content:flex-start}
  header h1{margin:0;font-size:20px;font-weight:600}
  header p{margin:2px 0;font-size:13px;opacity:.95}
  header .logo{width:56px;height:56px;border-radius:8px;overflow:hidden;background:#fff;display:flex;align-items:center;justify-content:center}
  header .logo img{max-width:48px;max-height:48px;display:block}

  .nav{display:flex;gap:8px;margin:14px 0 20px;flex-wrap:wrap}
  .nav button{background:#fff;color:var(--text);border:1px solid #dcdcdc;padding:8px 12px;border-radius:var(--btn-radius);cursor:pointer;font-weight:600;font-size:13px}
  .nav button.active{background:var(--accent);color:#fff;border-color:var(--accent)}

  .page{display:none;background:var(--panel);padding:16px;border-radius:var(--radius);margin-bottom:18px}
  .page.active{display:block}
  h2{margin-top:0;margin-bottom:8px;font-size:18px}
  p.lead{margin-top:0;margin-bottom:12px;color:var(--muted)}
  .grid{display:grid;gap:12px}
  .grid.cols-2{grid-template-columns:repeat(2,1fr)}
  .grid.cols-4{grid-template-columns:repeat(4,1fr)}
  .card{background:#fff;border-radius:8px;padding:12px;border:1px solid #eee}
  label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
  input[type="number"], input[type="text"], textarea, select{width:100%;padding:8px 10px;border-radius:6px;border:1px solid #ddd;font-size:14px}
  input[type="number"]::-webkit-inner-spin-button,
  input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
  .small{font-size:13px;color:var(--muted)}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:10px;border:1px solid #eee;text-align:left;font-size:14px}
  th{background:#fafafa;font-weight:700;color:var(--muted);text-transform:uppercase;font-size:12px}
  .btn{display:inline-block;padding:8px 12px;border-radius:var(--btn-radius);border:1px solid #111;background:#111;color:#fff;cursor:pointer;font-weight:600;font-size:13px}
  .btn.secondary{background:#fff;color:#111;border:1px solid #111}
  .btn.ghost{background:transparent;color:#111;border:1px solid #ccc}
  .btn.restore{background:#fff;color:#111;border:1px dashed #bbb}
  .btn.small{padding:6px 8px;font-size:13px}
  .btn.delete{background:#000;color:#fff;border:1px solid #000;padding:6px 8px;border-radius:6px}
  .muted{color:var(--muted)}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:40}
  .modal .box{background:#fff;padding:18px;border-radius:10px;width:96%;max-width:980px;box-shadow:0 8px 30px rgba(0,0,0,0.12)}
  .muted-small{color:var(--muted);font-size:13px}
  .company-header{display:flex;gap:12px;align-items:center;margin-bottom:8px}
  .company-header img{width:72px;height:72px;border-radius:8px;object-fit:contain}
  .settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:860px){.settings-grid{grid-template-columns:1fr}}
  .worker-settings-list .worker-card{background:#fafafa;border-radius:8px;padding:10px;margin-bottom:10px;border:1px solid #eee}
  .worker-settings-list .ws-row-top{margin-bottom:8px}
  .worker-settings-list .ws-row-bottom{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
  @media (max-width:860px){ .worker-settings-list .ws-row-bottom{grid-template-columns:repeat(2,1fr)} }
  .worker-settings-row input, .worker-settings-row select{padding:6px;font-size:13px}

  @media (max-width:640px){
    table{display:block;overflow:auto;white-space:nowrap}
    header{flex-direction:column;align-items:flex-start;gap:8px}
    header .logo{width:48px;height:48px}
    header h1{font-size:18px}
    .grid.cols-4{grid-template-columns:repeat(2,1fr)}
    .grid.cols-2{grid-template-columns:1fr}
  }

  @media print{
    body *{visibility:visible}
    .no-print{display:none !important}
    @page { size: A4; margin: 12mm; }
  }

  .print-page{background:#fff;color:#000;max-width:780px;margin:0 auto;padding:18px;border-radius:6px;min-height:280px;display:block}
  .print-page table{margin-bottom:18px}
  .page-break{page-break-after:always; break-after:page}
  .invoice-total{font-weight:800;font-size:18px}

  .worker-card input{width:100%}
  .setting-section-title{font-weight:700;margin-bottom:6px}
  .hidden {display:none !important}

  .signature-right{margin-top:26px;display:flex;justify-content:flex-end;Align-items:flex-end}
  .signature-line{border-top:1px solid #000;width:40%;padding-top:8px}
  .signature-caption{font-size:12px;color:#333;margin-top:6px;text-align:center}

  .auto-badge{font-size:12px;color:#0f5132;background:#d1e7dd;padding:6px;border-radius:6px;display:inline-block}
  .manual-badge{font-size:12px;color:#842029;background:#f8d7da;padding:6px;border-radius:6px;display:inline-block}
</style>
</head>
<body>
<div class="container">

  <header>
    <div class="logo">
      <img id="header-logo" src="assets/favicon.png" alt="Company logo" onerror="this.style.display='none'"/>
    </div>
    <div style="text-align:left">
      <h1 id="header-name">Nazmul Twisting Mill</h1>
      <p class="small" id="header-contact">Old Bogura Road, Telkupi — Phone: (+880) 1766759293 — Email: nazmul.fig@gmail.com</p>
    </div>
  </header>

  <nav class="nav" role="navigation" aria-label="Main">
    <button class="nav-btn active" data-page="dashboard">Dashboard</button>
    <button class="nav-btn" data-page="bill-summary">Bill Summary</button>
    <button class="nav-btn" data-page="settings">Settings</button>
  </nav>

  <!-- DASHBOARD -->
  <section id="dashboard" class="page active">
    <h2>Dashboard</h2>
    <p class="lead">Summary and histories</p>

    <div class="grid cols-4">
      <div class="card">
        <div class="small">Revenue from Mohajon</div>
        <div id="summary-mohajon" style="font-weight:700;font-size:20px">৳0.00</div>
      </div>
      <div class="card">
        <div class="small">Total Worker Payments</div>
        <div id="summary-workers" style="font-weight:700;font-size:20px">৳0.00</div>
      </div>
      <div class="card">
        <div class="small">Total Expenses</div>
        <div id="summary-expenses" style="font-weight:700;font-size:20px">৳0.00</div>
      </div>
      <div class="card">
        <div class="small">Weekly Profit</div>
        <div id="summary-profit" style="font-weight:700;font-size:20px">৳0.00</div>
      </div>
    </div>

    <div style="margin-top:18px">
      <h3 style="margin-bottom:10px">Weekly Production Summary</h3>
      <div class="small">Saved weekly production summaries (will appear here after you press <strong>Save Summary</strong> in Bill Summary).</div>

      <div id="weekly-invoices-wrapper" style="margin-top:8px" class="card hidden">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div class="small">Saved invoices from saved summaries</div>
          <div style="display:flex;gap:8px;align-items:center"></div>
        </div>
        <div id="weekly-invoices-list">
          <table id="weekly-invoices-table">
            <thead><tr><th>Invoice #</th><th>Date</th><th>Period</th><th>Total</th><th>Actions</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

  </section>

  <!-- BILL SUMMARY -->
  <section id="bill-summary" class="page">
    <h2>Bill Summary</h2>
    <p class="lead">A printable summary that includes Mohajon, worker production, expenses and net revenue.</p>

    <div class="card printable" id="bill-summary-card">
      <div class="company-header">
        <img id="bs-logo" src="assets/favicon.png" alt="logo" onerror="this.style.display='none'"/>
        <div>
          <div style="font-weight:700" id="company-name-display">Nazmul Twisting Mill</div>
          <div class="muted-small" id="company-address-display">Old Bogura Road, Telkupi</div>
          <div class="muted-small" id="company-phone-display">Phone: (+880) 1766759293</div>
          <div class="muted-small" id="company-email-display">Email: nazmul.fig@gmail.com</div>
        </div>
      </div>

      <h3 style="margin-top:0">Mohajon (Details)</h3>
      <table>
        <thead><tr><th>Rate (৳/pound)</th><th>Total Production (pounds)</th><th>Bill</th><th>Money Given</th><th>Due</th></tr></thead>
        <tbody>
          <tr>
            <td id="bs-mohajon-rate">৳0.00</td>
            <td id="bs-total-production">0.00</td>
            <td id="bs-total-bill">৳0.00</td>
            <td id="bs-total-given">৳0.00</td>
            <td id="bs-total-due">৳0.00</td>
          </tr>
        </tbody>
      </table>

      <h3 style="margin-top:12px">Workers Production</h3>
      <div class="small"><strong>One double = ten pounds.</strong></div>
      <table>
        <thead><tr><th>Worker</th><th>Role</th><th style="text-align:right">Production (double)</th><th style="text-align:right">Rate (৳/double)</th><th style="text-align:right">Bill</th><th style="text-align:right">Adjustment</th><th style="text-align:right">Bonus</th><th style="text-align:right">Final Amount</th></tr></thead>
        <tbody id="bill-summary-workers-body"></tbody>
        <tfoot>
          <tr>
            <th colspan="7" style="text-align:right">Subtotal</th>
            <th id="bs-workers-subtotal">৳0.00</th>
          </tr>
        </tfoot>
      </table>

      <h3 style="margin-top:12px">Expenses</h3>
      <table>
        <thead><tr><th>Electricity</th><th>Maintenance</th><th>Other</th><th>Total</th></tr></thead>
        <tbody>
          <tr>
            <td id="bs-exp-elec">৳0.00</td>
            <td id="bs-exp-maint">৳0.00</td>
            <td id="bs-exp-other">৳0.00</td>
            <td id="bs-exp-total">৳0.00</td>
          </tr>
        </tbody>
      </table>

      <h3 style="margin-top:12px">Summary</h3>
      <table>
        <thead><tr><th>Income (Money Given)</th><th>Payments to Workers</th><th>Expenses</th><th>Net Revenue</th></tr></thead>
        <tbody>
          <tr>
            <td id="bs-income">৳0.00</td>
            <td id="bs-payments">৳0.00</td>
            <td id="bs-expenses">৳0.00</td>
            <td id="bs-net">৳0.00</td>
          </tr>
        </tbody>
      </table>

      <div class="actions" style="margin-top:12px">
        <button class="btn" id="save-summary-btn">Save Summary</button>
      </div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="settings" class="page">
    <h2>Settings</h2>
    <p class="lead">Update company details, worker details, mohajon info (rate, total production, money given) and expenses. Save or reset from below.</p>

    <div class="card">
      <div class="settings-grid">
        <div>
          <div class="setting-section-title">Company Info</div>
          <label>Company Name</label>
          <input type="text" id="setting-company-name" />

          <label style="margin-top:8px">Address</label>
          <textarea id="setting-company-address" rows="2"></textarea>

          <label style="margin-top:8px">Phone</label>
          <input type="text" id="setting-company-phone" />

          <label style="margin-top:8px">Email</label>
          <input type="text" id="setting-company-email" />
        </div>

        <div>
          <div class="setting-section-title">Mohajon & Production</div>
          <label>Mohajon — Company Name</label>
          <input type="text" id="setting-mohajon-company" />

          <label style="margin-top:8px">Mohajon Address</label>
          <input type="text" id="setting-mohajon-address" />

          <label style="margin-top:8px">Mohajon Phone</label>
          <input type="text" id="setting-mohajon-phone" />

          <label style="margin-top:8px">Mohajon Rate (৳/pound)</label>
          <input type="number" id="setting-mohajon-rate" step="0.01" min="0" placeholder="Rate (e.g. 120.00)" />

          <label style="margin-top:8px">Total Production (pounds) <span id="mohajon-production-badge" class="auto-badge" style="margin-left:8px">Auto</span></label>
          <input type="number" id="setting-mohajon-totalproduction" step="0.01" min="0" placeholder="Auto: (Machine1 + Machine2) * 10" data-auto="true" />

          <label style="margin-top:8px">Mohajon Money Given (৳)</label>
          <input type="number" id="setting-mohajon-moneygiven" step="0.01" min="0" placeholder="Money given (e.g. 5000.00)" />
        </div>
      </div>

      <hr style="margin:12px 0;border-top:1px solid #eee" />

      <div style="margin-bottom:12px">
        <h3 style="margin:6px 0">Expenses</h3>
        <div class="small">Set expenses below. Expenses are saved when you click <strong>Save Data</strong>.</div>
        <div style="margin-top:8px" class="grid cols-2">
          <div>
            <label>Electricity (৳)</label>
            <input type="number" id="expense-electricity" value="0" min="0" step="0.01" />
          </div>
          <div>
            <label>Maintenance (৳)</label>
            <input type="number" id="expense-maintenance" value="0" min="0" step="0.01" />
          </div>
          <div>
            <label>Other (৳)</label>
            <input type="number" id="expense-other" value="0" min="0" step="0.01" />
          </div>
          <div style="display:flex;align-items:end;gap:8px">
            <div style="width:100%">
              <div class="small" style="color:var(--muted)">Note: To revert expenses to zero, use the Reset Data button below.</div>
            </div>
          </div>
        </div>
      </div>

      <hr style="margin:12px 0;border-top:1px solid #eee" />

      <div>
        <h3 style="margin:6px 0">Worker Details (5 Workers)</h3>
        <div class="small">Edit worker information and financial defaults. After saving, values update throughout the app.</div>
        <div id="worker-settings-list" class="worker-settings-list" style="margin-top:12px"></div>

        <div style="margin-top:14px">
          <div class="small" style="margin-top:8px">Note: Deletions require typing <code>delete</code> in the confirmation box.</div>

          <div class="actions" style="margin-top:12px">
            <button class="btn" id="save-data-btn">Save Data</button>
            <button class="btn secondary" id="reset-data-btn">Reset Data</button>
          </div>
        </div>
      </div>
    </div>
  </section>

</div>

<!-- Modal: typed-delete / generic confirm -->
<div class="modal" id="confirm-modal">
  <div class="box">
    <div id="confirm-text" style="font-weight:700">Confirm action</div>
    <div id="confirm-subtext" class="muted-small" style="margin-top:8px">Type <strong>delete</strong> below to confirm.</div>
    <input type="text" id="confirm-input" placeholder="Type delete to confirm" style="margin-top:12px;padding:8px;border-radius:6px;border:1px solid #ddd;width:100%" />
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button class="btn secondary" id="confirm-cancel">Cancel</button>
      <button class="btn" id="confirm-ok">OK</button>
    </div>
  </div>
</div>

<script>
/* ---------------------------
   App data model + persistence
   --------------------------- */
const STORAGE_KEY = 'ntm_app_v9_workers_per_double';

function defaultState() {
  return {
    company: {
      name: 'Nazmul Twisting Mill',
      address: 'Old Bogura Road, Telkupi',
      phone: '(+880) 1766759293',
      email: 'nazmul.fig@gmail.com',
      logo: 'assets/favicon.png'
    },
    mohajon: {
      company: 'Bukhari & Co.',
      address: 'Goshala, Sirajgang',
      phone: '',
      rate: 20,               // ৳/pound default for Mohajon
      totalProduction: 0,     // pounds, can be auto-filled or manually changed
      moneyGiven: 0
    },
    // five workers: Machine1, Machine2, Drum1, Drum2, Kun
    // rate is now in ৳ per double
    workers: [
      { id: 'w1', name: 'Machine 1', designation: 'Machine', rate: 45, adjustment: 0, bonus: 0, phone:'', address:'' },
      { id: 'w2', name: 'Machine 2', designation: 'Machine', rate: 45, adjustment: 0, bonus: 0, phone:'', address:'' },
      { id: 'w3', name: 'Drum 1', designation: 'Drum Machine', rate: 28, adjustment: 0, bonus: 0, phone:'', address:'' },
      { id: 'w4', name: 'Drum 2', designation: 'Drum Machine', rate: 28, adjustment: 0, bonus: 0, phone:'', address:'' },
      { id: 'w5', name: 'Kun 1', designation: 'Kun Machine', rate: 19, adjustment: 0, bonus: 0, phone:'', address:'' }
    ],
    // productionInputs are in "double" units (1 double = 10 pounds)
    productionInputs: { 'w1': 0, 'w2': 0, 'w3': 0, 'w4': 0, 'w5': 0 },
    expenses: { electricity: 0, maintenance: 0, other: 0 },
    invoices: [],
    billingHistory: {},
    summaries: []
  };
}

let appState = loadState() || defaultState();

/* ---------------------------
   Utilities
   --------------------------- */
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(appState)); renderAll(); }
function loadState(){ try{ const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : null }catch(e){ console.error(e); return null } }
function updateFavicon(url){ const link = document.getElementById('favico') || document.querySelector('link[rel="icon"]'); if(link){ link.href = url; } }
function formatMoney(n){ return '৳' + Number(n || 0).toFixed(2); }
function formatDateISO(d=new Date()){ return d.toLocaleDateString() + ' ' + d.toLocaleTimeString(); }
function getWeekPeriodText(d=new Date()){ const end=new Date(d); const start=new Date(d); start.setDate(end.getDate()-6); return `${start.toLocaleDateString()} - ${end.toLocaleDateString()}`; }
function onlyDigits(str=''){ return (String(str||'').match(/\d+/g) || []).join('') || Math.floor(100000+Math.random()*900000); }
function escapeHtml(str){ if(str===null||str===undefined) return ''; return String(str).replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];}); }

// Helper: convert doubles to pounds (1 double = 10 pounds)
function doublesToPounds(d){ return Number(d || 0) * 10; }

/* ---------------------------
   Navigation wiring
   --------------------------- */
document.querySelectorAll('.nav-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const page = btn.dataset.page;
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    const el = document.getElementById(page);
    if(el) el.classList.add('active');
    if(page === 'bill-summary') renderBillSummary();
    if(page === 'settings') populateSettingsForm();
  });
});

/* ---------------------------
   Apply company header
   --------------------------- */
function applyCompanyHeader(){
  const c = appState.company || {};
  const headerName = document.getElementById('header-name');
  const headerContact = document.getElementById('header-contact');
  const headerLogo = document.getElementById('header-logo');
  const bsLogo = document.getElementById('bs-logo');
  const compName = document.getElementById('company-name-display');
  const compAddr = document.getElementById('company-address-display');
  const compPhone = document.getElementById('company-phone-display');
  const compEmail = document.getElementById('company-email-display');

  if(headerName) headerName.textContent = (c.name || 'Company');
  if(headerContact) headerContact.textContent = `${c.address || ''} — Phone: ${c.phone || ''} — Email: ${c.email || ''}`;
  if(headerLogo) { headerLogo.src = c.logo || 'assets/favicon.png'; headerLogo.style.display = c.logo ? '' : ''; }
  if(bsLogo) { bsLogo.src = c.logo || 'assets/favicon.png'; bsLogo.style.display = ''; }
  if(compName) compName.textContent = c.name || '';
  if(compAddr) compAddr.textContent = c.address || '';
  if(compPhone) compPhone.textContent = `Phone: ${c.phone || ''}`;
  if(compEmail) compEmail.textContent = `Email: ${c.email || ''}`;

  if(c.logo) updateFavicon(c.logo);
}

/* ---------------------------
   Render functions
   --------------------------- */
function renderAll(){
  renderDashboard();
  renderBillSummary();
  renderWeeklyInvoicesTable();
  populateWorkerSettingsList();
  applyCompanyHeader();
  renderExpenses();
}

/* DASHBOARD */
function renderDashboard(){
  const mohajonAmt = Number(appState.mohajon.moneyGiven || 0);
  const totalWorkersPaid = computeWorkersTotalPaid();
  const expensesTotal = (appState.expenses.electricity||0) + (appState.expenses.maintenance||0) + (appState.expenses.other||0);
  const profit = mohajonAmt - totalWorkersPaid - expensesTotal;
  document.getElementById('summary-mohajon').textContent = formatMoney(mohajonAmt);
  document.getElementById('summary-workers').textContent = formatMoney(totalWorkersPaid);
  document.getElementById('summary-expenses').textContent = formatMoney(expensesTotal);
  document.getElementById('summary-profit').textContent = formatMoney(profit);
}

/* BILL SUMMARY rendering */
function renderBillSummary(){
  const mo = appState.mohajon || {};

  // If mohajon.totalProduction is falsy (0) compute default from Machine 1 & 2 doubles
  const sumMachineDoubles = (Number(appState.productionInputs['w1']||0) + Number(appState.productionInputs['w2']||0));
  const derivedMohajonTotal = doublesToPounds(sumMachineDoubles);
  if(!Number(mo.totalProduction) || Number(mo.totalProduction) === 0){
    document.getElementById('bs-total-production').textContent = Number(derivedMohajonTotal).toFixed(2);
  } else {
    document.getElementById('bs-total-production').textContent = Number(mo.totalProduction||0).toFixed(2);
  }

  const bill = Number(mo.rate || 0) * ( Number(mo.totalProduction || 0) || derivedMohajonTotal );
  document.getElementById('bs-mohajon-rate').textContent = formatMoney(mo.rate || 0);
  document.getElementById('bs-total-bill').textContent = formatMoney(bill);
  document.getElementById('bs-total-given').textContent = formatMoney(mo.moneyGiven || 0);
  document.getElementById('bs-total-due').textContent = formatMoney(bill - (mo.moneyGiven || 0));

  const tbody = document.getElementById('bill-summary-workers-body');
  tbody.innerHTML = '';
  let workersSubtotal = 0;
  appState.workers.forEach(w=>{
    // production inputs are stored as doubles; worker bill = rate * doubles (rate is per double)
    const doubles = Number(appState.productionInputs[w.id] || 0);
    const earnings = doubles * Number(w.rate || 0);
    const adjustment = Number(w.adjustment || 0);
    const bonus = Number(w.bonus || 0);
    const finalAmount = earnings - adjustment + bonus;
    workersSubtotal += finalAmount;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(w.name)}</td><td>${escapeHtml(w.designation)}</td><td style="text-align:right">${doubles.toFixed(2)}</td><td style="text-align:right">${formatMoney(w.rate)}</td><td style="text-align:right">${formatMoney(earnings)}</td><td style="text-align:right">${formatMoney(adjustment)}</td><td style="text-align:right">${formatMoney(bonus)}</td><td style="text-align:right">${formatMoney(finalAmount)}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('bs-workers-subtotal').textContent = formatMoney(workersSubtotal);

  const expElec = Number(appState.expenses.electricity || 0);
  const expMaint = Number(appState.expenses.maintenance || 0);
  const expOther = Number(appState.expenses.other || 0);
  const expTotal = expElec + expMaint + expOther;
  document.getElementById('bs-exp-elec').textContent = formatMoney(expElec);
  document.getElementById('bs-exp-maint').textContent = formatMoney(expMaint);
  document.getElementById('bs-exp-other').textContent = formatMoney(expOther);
  document.getElementById('bs-exp-total').textContent = formatMoney(expTotal);

  const income = Number(appState.mohajon.moneyGiven || 0);
  const payments = workersSubtotal;
  const net = income - payments - expTotal;
  document.getElementById('bs-income').textContent = formatMoney(income);
  document.getElementById('bs-payments').textContent = formatMoney(payments);
  document.getElementById('bs-expenses').textContent = formatMoney(expTotal);
  document.getElementById('bs-net').textContent = formatMoney(net);
}

/* Weekly invoices table on dashboard (Weekly Summary button before Workers) */
function renderWeeklyInvoicesTable(){
  const tbody = document.querySelector('#weekly-invoices-table tbody');
  if(!tbody) return;
  tbody.innerHTML = '';
  const wrapper = document.getElementById('weekly-invoices-wrapper');
  const invoices = appState.invoices || [];
  if(!invoices.length){
    wrapper.classList.add('hidden');
    return;
  }
  wrapper.classList.remove('hidden');

  invoices.forEach((inv, idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(inv.id)}</td><td>${escapeHtml(inv.date)}</td><td>${escapeHtml(inv.period)}</td><td>${formatMoney(inv.total)}</td><td></td>`;
    const actionsTd = tr.querySelector('td:last-child');

    // Weekly Summary button first
    const weeklyBtn = document.createElement('button');
    weeklyBtn.className = 'btn small';
    weeklyBtn.textContent = 'Weekly Summary';
    weeklyBtn.addEventListener('click', ()=> previewSummaryForInvoice(idx));
    actionsTd.appendChild(weeklyBtn);

    // Workers button (no "(Preview)" text)
    const previewBtn = document.createElement('button');
    previewBtn.className = 'btn small';
    previewBtn.style.marginLeft='8px';
    previewBtn.textContent = 'Workers';
    previewBtn.addEventListener('click', ()=> previewInvoiceSummary(idx));
    actionsTd.appendChild(previewBtn);

    // Per-Worker combined
    const printWorkersBtn = document.createElement('button');
    printWorkersBtn.className = 'btn small';
    printWorkersBtn.style.marginLeft='8px';
    printWorkersBtn.textContent = 'Per-Worker';
    printWorkersBtn.addEventListener('click', ()=> previewAllWorkersForInvoice(idx));
    actionsTd.appendChild(printWorkersBtn);

    // Receipt
    const receiptBtn = document.createElement('button');
    receiptBtn.className = 'btn small';
    receiptBtn.style.marginLeft='8px';
    receiptBtn.textContent = 'Receipt';
    receiptBtn.addEventListener('click', ()=> previewMohajonReceipt(idx));
    actionsTd.appendChild(receiptBtn);

    const del = document.createElement('button');
    del.className = 'btn delete';
    del.style.marginLeft = '8px';
    del.textContent = 'Delete';
    del.addEventListener('click', ()=> confirmDeleteInvoice(idx));
    actionsTd.appendChild(del);

    tbody.appendChild(tr);
  });
}

/* ---------------------------
   Computations & interactions
   --------------------------- */
function computeWorkersTotalPaid(){
  let total = 0;
  appState.workers.forEach(w=>{
    const doubles = Number(appState.productionInputs[w.id] || 0);
    const earnings = doubles * Number(w.rate || 0);
    const finalAmount = earnings - Number(w.adjustment || 0) + Number(w.bonus || 0);
    total += finalAmount;
  });
  return total;
}

/* ---------------------------
   Settings: populate, worker list, save, reset (combined)
   --------------------------- */

function populateSettingsForm(){
  // company
  const c = appState.company || {};
  document.getElementById('setting-company-name').value = c.name || '';
  document.getElementById('setting-company-address').value = c.address || '';
  document.getElementById('setting-company-phone').value = c.phone || '';
  document.getElementById('setting-company-email').value = c.email || '';

  // mohajon
  const m = appState.mohajon || {};
  document.getElementById('setting-mohajon-company').value = m.company || '';
  document.getElementById('setting-mohajon-address').value = m.address || '';
  document.getElementById('setting-mohajon-phone').value = m.phone || '';
  document.getElementById('setting-mohajon-rate').value = Number(m.rate||0) !== 0 ? Number(m.rate).toFixed(2) : '';

  // compute derived defaults:
  const sumMachineDoubles = (Number(appState.productionInputs['w1']||0) + Number(appState.productionInputs['w2']||0));
  const derivedMohajonTotal = doublesToPounds(sumMachineDoubles); // pounds
  // If stored totalProduction is non-zero use that; otherwise display derived
  const prodInputEl = document.getElementById('setting-mohajon-totalproduction');
  if((Number(m.totalProduction||0) !== 0) && prodInputEl.dataset.manual === 'true'){
    prodInputEl.value = Number(m.totalProduction).toFixed(2);
    prodInputEl.dataset.auto = 'false';
    document.getElementById('mohajon-production-badge').className = 'manual-badge';
    document.getElementById('mohajon-production-badge').textContent = 'Manual';
  } else {
    prodInputEl.value = (Number(m.totalProduction||0) !== 0) ? Number(m.totalProduction).toFixed(2) : (derivedMohajonTotal !== 0 ? derivedMohajonTotal.toFixed(2) : '');
    prodInputEl.dataset.auto = prodInputEl.value !== '' ? 'true' : 'true';
    document.getElementById('mohajon-production-badge').className = 'auto-badge';
    document.getElementById('mohajon-production-badge').textContent = 'Auto';
  }

  document.getElementById('setting-mohajon-moneygiven').value = Number(m.moneyGiven||0) !== 0 ? Number(m.moneyGiven).toFixed(2) : '';

  // worker list (and production inputs)
  populateWorkerSettingsList();

  // expenses (moved to settings)
  renderExpenses();
}

/* Populate worker settings list */
function populateWorkerSettingsList(){
  const container = document.getElementById('worker-settings-list');
  if(!container) return;
  container.innerHTML = '';
  appState.workers.forEach(w => {
    const card = document.createElement('div');
    card.className = 'worker-card';
    card.style.marginBottom = '10px';
    card.dataset.workerId = w.id;

    const rowTop = document.createElement('div');
    rowTop.className = 'ws-row-top';
    rowTop.innerHTML = `<input class="ws-name" placeholder="Name" value="${escapeHtml(w.name)}" />`;

    const rateValue = Number(w.rate || 0) !== 0 ? Number(w.rate).toFixed(2) : '';
    const adjustValue = Number(w.adjustment || 0) !== 0 ? Number(w.adjustment).toFixed(2) : '';
    const bonusValue = Number(w.bonus || 0) !== 0 ? Number(w.bonus).toFixed(2) : '';
    // productionInputs are doubles; display those in settings
    const doublesValue = Number(appState.productionInputs[w.id] || 0) !== 0 ? Number(appState.productionInputs[w.id]).toFixed(2) : '';

    const rowBottom = document.createElement('div');
    rowBottom.className = 'ws-row-bottom';
    rowBottom.style.display = 'grid';
    rowBottom.style.gridTemplateColumns = 'repeat(7,1fr)';
    rowBottom.style.gap = '8px';
    rowBottom.innerHTML = `
      <input class="ws-address" placeholder="Address" value="${escapeHtml(w.address||'')}" />
      <input class="ws-phone" placeholder="Phone" value="${escapeHtml(w.phone||'')}" />
      <input class="ws-designation" placeholder="Designation" value="${escapeHtml(w.designation||'')}" />
      <input type="number" class="ws-rate" placeholder="Rate (৳/double)" step="0.01" min="0" value="${escapeHtml(rateValue)}" />
      <input type="number" class="ws-pounds" placeholder="Production (double units)" step="0.01" min="0" value="${escapeHtml(doublesValue)}" data-auto="true" />
      <input type="number" class="ws-adjust" placeholder="Adjustment (e.g. 5.00)" step="0.01" value="${escapeHtml(adjustValue)}" />
      <input type="number" class="ws-bonus" placeholder="Bonus (e.g. 10.00)" step="0.01" value="${escapeHtml(bonusValue)}" />
    `;

    card.appendChild(rowTop);
    card.appendChild(rowBottom);
    container.appendChild(card);
  });

  // Attach input listeners for Machine1 and Machine2 production to auto-update Mohajon total production and Kun (w5)
  attachProductionAutoFillListeners();
}

/* Attach listeners to machine production inputs so mohajon and kun auto-fill */
function attachProductionAutoFillListeners(){
  // find machine inputs (w1,w2) and kun input (w5) and mohajon production input
  const prodInputEl = document.getElementById('setting-mohajon-totalproduction');
  const kunCard = Array.from(document.querySelectorAll('.worker-card')).find(c=>c.dataset.workerId==='w5');
  const kunInput = kunCard ? kunCard.querySelector('.ws-pounds') : null;

  function updateAutoTargets(){
    const w1El = document.querySelector('.worker-card[data-worker-id="w1"] .ws-pounds');
    const w2El = document.querySelector('.worker-card[data-worker-id="w2"] .ws-pounds');
    const w1 = Number(w1El ? w1El.value : 0) || 0;
    const w2 = Number(w2El ? w2El.value : 0) || 0;
    const sum = w1 + w2;
    // Mohajon: only update if it's in auto mode (dataset.auto !== 'false')
    if(prodInputEl && prodInputEl.dataset.auto !== 'false'){
      const newMohPounds = (sum * 10);
      prodInputEl.value = Number(newMohPounds || 0).toFixed(2);
      prodInputEl.dataset.auto = 'true';
      document.getElementById('mohajon-production-badge').className = 'auto-badge';
      document.getElementById('mohajon-production-badge').textContent = 'Auto';
    }
    // Kun: only update if kun input has data-auto !== 'false'
    if(kunInput && kunInput.dataset.auto !== 'false'){
      kunInput.value = Number(sum || 0).toFixed(2);
      kunInput.dataset.auto = 'true';
    }
    // live update preview on settings page
    ['w1','w2'].forEach(id=>{
      const el = document.querySelector('.worker-card[data-worker-id="'+id+'"] .ws-pounds');
      if(el) appState.productionInputs[id] = parseFloat(el.value || '0') || 0;
    });
    if(kunInput) appState.productionInputs['w5'] = parseFloat(kunInput.value || '0') || 0;
    renderBillSummary();
  }

  // Bind input events for machine1 and machine2
  ['w1','w2'].forEach(id=>{
    const el = document.querySelector('.worker-card[data-worker-id="'+id+'"] .ws-pounds');
    if(el){
      el.addEventListener('input', ()=>{
        appState.productionInputs[id] = parseFloat(el.value || '0') || 0;
        updateAutoTargets();
      });
      el.addEventListener('change', ()=> updateAutoTargets());
    }
  });

  // Mohajon production manual toggle
  if(prodInputEl){
    prodInputEl.addEventListener('input', ()=>{
      if(prodInputEl.value !== ''){
        prodInputEl.dataset.auto = 'false';
        prodInputEl.dataset.manual = 'true';
        document.getElementById('mohajon-production-badge').className = 'manual-badge';
        document.getElementById('mohajon-production-badge').textContent = 'Manual';
      } else {
        prodInputEl.dataset.auto = 'true';
        prodInputEl.dataset.manual = 'false';
        document.getElementById('mohajon-production-badge').className = 'auto-badge';
        document.getElementById('mohajon-production-badge').textContent = 'Auto';
      }
    });
  }

  // Kun input manual toggle
  if(kunInput){
    kunInput.addEventListener('input', ()=>{
      if(kunInput.value !== ''){
        kunInput.dataset.auto = 'false';
      } else {
        kunInput.dataset.auto = 'true';
      }
      appState.productionInputs['w5'] = parseFloat(kunInput.value||'0') || 0;
      renderBillSummary();
    });
  }

  // initial call to set derived values
  updateAutoTargets();
}

/* perform Save Data action (actual save logic) */
function performSaveData(){
  // Company
  const name = document.getElementById('setting-company-name').value || '';
  const address = document.getElementById('setting-company-address').value || '';
  const phone = document.getElementById('setting-company-phone').value || '';
  const email = document.getElementById('setting-company-email').value || '';

  appState.company = appState.company || {};
  appState.company.name = name;
  appState.company.address = address;
  appState.company.phone = phone;
  appState.company.email = email;

  // Mohajon
  appState.mohajon = appState.mohajon || {};
  appState.mohajon.company = document.getElementById('setting-mohajon-company').value || '';
  appState.mohajon.address = document.getElementById('setting-mohajon-address').value || '';
  appState.mohajon.phone = document.getElementById('setting-mohajon-phone').value || '';
  appState.mohajon.rate = parseFloat(document.getElementById('setting-mohajon-rate').value) || 0;

  // allow manual override of totalProduction: if user inputs value and marked manual, use that; otherwise compute from machine1+2 doubles
  const totalProdInputEl = document.getElementById('setting-mohajon-totalproduction');
  if(totalProdInputEl && totalProdInputEl.dataset.auto === 'false' && totalProdInputEl.value !== ''){
    appState.mohajon.totalProduction = parseFloat(totalProdInputEl.value) || 0;
  } else {
    const sumMachineDoubles = (Number(appState.productionInputs['w1']||0) + Number(appState.productionInputs['w2']||0));
    appState.mohajon.totalProduction = doublesToPounds(sumMachineDoubles); // pounds
  }
  appState.mohajon.moneyGiven = parseFloat(document.getElementById('setting-mohajon-moneygiven').value) || 0;

  // Workers + production input
  const cards = document.querySelectorAll('.worker-card');
  cards.forEach(card=>{
    const id = card.dataset.workerId;
    const name = card.querySelector('.ws-name').value.trim() || 'Unnamed';
    const phone = card.querySelector('.ws-phone').value.trim() || '';
    const address = card.querySelector('.ws-address').value.trim() || '';
    const designation = card.querySelector('.ws-designation').value.trim() || '';
    const rate = parseFloat(card.querySelector('.ws-rate').value) || 0;
    // production input stored as doubles unit
    const doubles = parseFloat(card.querySelector('.ws-pounds').value) || 0;
    const adjustment = parseFloat(card.querySelector('.ws-adjust').value) || 0;
    const bonus = parseFloat(card.querySelector('.ws-bonus').value) || 0;
    const w = appState.workers.find(x=>x.id===id);
    if(w){
      w.name = name; w.phone = phone; w.address = address; w.designation = designation;
      w.rate = rate; w.adjustment = adjustment; w.bonus = bonus;
    }
    appState.productionInputs[id] = doubles;
    const inputEl = card.querySelector('.ws-pounds');
    if(inputEl && inputEl.dataset.auto === 'false'){
      inputEl.dataset.auto = 'false';
    }
  });

  // ensure Kun (w5) default double equals sum of machine1 + machine2 doubles unless user manually set Kun
  const kunEl = document.querySelector('.worker-card[data-worker-id="w5"] .ws-pounds');
  const machineSum = Number(appState.productionInputs['w1']||0) + Number(appState.productionInputs['w2']||0);
  if(kunEl && kunEl.dataset.auto !== 'false'){
    appState.productionInputs['w5'] = machineSum;
  }

  // expenses (settings area)
  appState.expenses.electricity = parseFloat(document.getElementById('expense-electricity').value) || 0;
  appState.expenses.maintenance = parseFloat(document.getElementById('expense-maintenance').value) || 0;
  appState.expenses.other = parseFloat(document.getElementById('expense-other').value) || 0;

  applyCompanyHeader();
  saveState();
  alert('Data saved.');
}

/* Save Data: show simple OK/Cancel confirmation before saving */
document.getElementById('save-data-btn').addEventListener('click', ()=>{
  showSimpleConfirm({
    message: 'Save settings and data? Click OK to confirm.',
    okLabel: 'OK',
    onConfirm: performSaveData
  });
});

/* Reset Data: typed delete confirm but defaultState contains the defaults requested */
document.getElementById('reset-data-btn').addEventListener('click', ()=>{
  showTypedConfirm({
    message: 'Reset all data to defaults? This will remove saved summaries and settings.',
    confirmWord: 'delete',
    okLabel: 'Reset',
    onConfirm: ()=>{
      appState = defaultState();
      saveState();
      location.reload();
    }
  });
});

/* ---------------------------
   Save Summary, invoices, preview functions
   --------------------------- */

/* helper: perform the actual save-summary logic (extracted)
   Now generates a single shared id for both invoice and summary so they match.
   Worker bills use rate * production(double)
*/
function performSaveSummaryAndNavigateDashboard(){
  const sharedId = 'INV-' + Math.floor(100000 + Math.random()*900000);

  const summary = {
    id: sharedId,
    date: formatDateISO(),
    period: getWeekPeriodText(),
    company: {...(appState.company || {})},
    mohajon: { ...appState.mohajon },
    workers: [],
    expenses: { ...appState.expenses },
    totals: {}
  };

  let workersSubtotal = 0;
  appState.workers.forEach(w=>{
    const doubles = Number(appState.productionInputs[w.id] || 0);
    const earnings = doubles * Number(w.rate || 0); // rate per double
    const adjustment = Number(w.adjustment || 0);
    const bonus = Number(w.bonus || 0);
    const finalAmount = earnings - adjustment + bonus;
    workersSubtotal += finalAmount;
    summary.workers.push({ id: w.id, name: w.name, designation: w.designation, doubles: doubles, rate: w.rate, earnings, adjustment, bonus, finalAmount, phone: w.phone || '', address: w.address || '' });
  });

  const expTotal = (summary.expenses.electricity||0) + (summary.expenses.maintenance||0) + (summary.expenses.other||0);
  const income = Number(summary.mohajon.moneyGiven || 0);
  const net = income - workersSubtotal - expTotal;

  summary.totals = { income, payments: workersSubtotal, expenses: expTotal, net };

  appState.summaries = appState.summaries || [];
  appState.summaries.unshift(summary);

  // Create invoice entry with per-worker items. Use same sharedId as invoice id.
  const invoice = {
    id: sharedId,
    date: summary.date,
    period: summary.period,
    total: summary.totals.payments,
    workers: summary.workers.map(w => ({ id:w.id, name:w.name, designation:w.designation, doubles: w.doubles, rate:w.rate, bill:w.earnings, adjustment:w.adjustment, bonus:w.bonus, total:w.finalAmount }))
  };

  appState.invoices = appState.invoices || [];
  appState.invoices.unshift(invoice);

  // add billing history entries; store invoice id in each history entry
  invoice.workers.forEach(w=>{
    appState.billingHistory[w.id] = appState.billingHistory[w.id] || [];
    appState.billingHistory[w.id].unshift({
      date: invoice.date,
      doubles: w.doubles,
      bill: w.bill,
      adjustment: w.adjustment,
      bonus: w.bonus,
      total: w.total,
      invoiceId: invoice.id
    });
  });

  saveState();
  document.querySelector('[data-page="dashboard"]').click();
}

/* Save Summary button: show simple OK/Cancel confirmation (no typing) */
document.getElementById('save-summary-btn').addEventListener('click', ()=>{
  showSimpleConfirm({
    message: 'Save this summary? Click OK to confirm.',
    okLabel: 'OK',
    onConfirm: performSaveSummaryAndNavigateDashboard
  });
});

/* ---------------------------
   Confirmation modal utilities
   --------------------------- */
function showTypedConfirm({message='Type delete to confirm', confirmWord='delete', okLabel='OK', onConfirm=null} = {}){ 
  const modal = document.getElementById('confirm-modal');
  const txt = document.getElementById('confirm-text');
  const sub = document.getElementById('confirm-subtext');
  const input = document.getElementById('confirm-input');
  const ok = document.getElementById('confirm-ok');
  const cancel = document.getElementById('confirm-cancel');

  txt.textContent = message;
  sub.innerHTML = `Type <strong>${escapeHtml(confirmWord)}</strong> below to confirm.`;
  input.value = '';
  input.style.display = '';
  modal.style.display = 'flex';
  input.focus();

  function cleanup(){ modal.style.display = 'none'; ok.removeEventListener('click', okHandler); cancel.removeEventListener('click', cancelHandler); }
  function okHandler(){ if((input.value||'').trim().toLowerCase()===String(confirmWord).toLowerCase()){ cleanup(); onConfirm && onConfirm(); } else { alert(`Type "${confirmWord}" exactly to confirm.`); input.focus(); } }
  function cancelHandler(){ cleanup(); }
  ok.textContent = okLabel || 'OK';
  ok.addEventListener('click', okHandler);
  cancel.addEventListener('click', cancelHandler);
}

function showSimpleConfirm({message='Are you sure?', okLabel='OK', onConfirm=null} = {}) {
  const modal = document.getElementById('confirm-modal');
  const txt = document.getElementById('confirm-text');
  const sub = document.getElementById('confirm-subtext');
  const input = document.getElementById('confirm-input');
  const ok = document.getElementById('confirm-ok');
  const cancel = document.getElementById('confirm-cancel');

  txt.textContent = message;
  sub.innerHTML = '';
  input.value = '';
  input.style.display = 'none';
  modal.style.display = 'flex';

  function cleanup(){ modal.style.display = 'none'; ok.removeEventListener('click', okHandler); cancel.removeEventListener('click', cancelHandler); }
  function okHandler(){ cleanup(); onConfirm && onConfirm(); }
  function cancelHandler(){ cleanup(); }
  ok.textContent = okLabel || 'OK';
  ok.addEventListener('click', okHandler);
  cancel.addEventListener('click', cancelHandler);
}

/* Reusable delete confirmation wrapper */
function showDeleteConfirm(message, onConfirm){
  showTypedConfirm({ message: message || 'Confirm delete', confirmWord: 'delete', okLabel: 'Delete', onConfirm });
}

/* ---------------------------
   PREVIEW & printing
   - replaced "Double" -> "Production (double)" where applicable
   - sentence changed to "One double = ten pounds."
   --------------------------- */
function openPreviewWindow(innerHtml, title = 'Preview'){
  const win = window.open('','_blank');
  if(!win) return alert('Unable to open preview. Please allow popups in your browser.');
  const baseStyles = `
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      body{font-family:Arial, Helvetica, sans-serif;color:#000;padding:12px}
      .topbar{display:flex;gap:8px;align-items:center;position:sticky;top:0;background:#fff;padding:8px 0;margin-bottom:8px;z-index:20}
      .topbar .title{font-weight:700;flex:1}
      .topbar button{padding:8px 12px;border-radius:6px;border:1px solid #111;background:#111;color:#fff;cursor:pointer;font-weight:600}
      .topbar button.secondary{background:#fff;color:#111}
      .print-page{max-width:780px;margin:0 auto;padding:18px;border-radius:6px;background:#fff;min-height:280px}
      table{width:100%;border-collapse:collapse;margin-top:8px}
      table,th,td{border:1px solid #ddd;padding:8px}
      th{background:#f6f6f6}
      .page-break{page-break-after:always; break-after:page}
      .signature-right{margin-top:26px;display:flex;justify-content:flex-end;align-items:flex-end}
      .signature-line{border-top:1px solid #000;width:40%;padding-top:8px}
      .signature-caption{font-size:12px;color:#333;margin-top:6px;text-align:center}
      @media print{
        .no-print{display:none !important}
        @page { size: A4; margin: 12mm; }
      }
    </style>
  `;
  const html = `
    <html>
      <head>
        <title>${escapeHtml(title)}</title>
        ${baseStyles}
      </head>
      <body>
        <div class="topbar no-print">
          <div class="title">${escapeHtml(title)}</div>
          <div style="display:flex;gap:6px">
            <button id="doPrint">Print / Save as PDF</button>
            <button id="closeWin" class="secondary">Close</button>
          </div>
        </div>

        <div id="content">${innerHtml}</div>

        <script>
          document.getElementById('doPrint').addEventListener('click', function(){ window.focus(); window.print(); });
          document.getElementById('closeWin').addEventListener('click', function(){ window.close(); });
          window.addEventListener('load', function(){ try{ window.focus(); }catch(e){} });
        <\/script>
      </body>
    </html>
  `;
  win.document.write(html);
  win.document.close();
  win.focus();
}

function companyHeaderHtml(company){
  return `
    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
      <div style="display:flex;gap:12px;align-items:center">
        <img src="${escapeHtml(company.logo||'assets/favicon.png')}" alt="logo" style="width:72px;height:72px;object-fit:contain;border-radius:8px" onerror="this.style.display='none'"/>
        <div>
          <div style="font-weight:700;font-size:18px">${escapeHtml(company.name || '')}</div>
          <div style="font-size:12px;color:#333">${escapeHtml(company.address || '')}</div>
          <div style="font-size:12px;color:#333">${escapeHtml(company.phone || '')}</div>
          ${company.email ? `<div style="font-size:12px;color:#333">${escapeHtml(company.email)}</div>` : ''}
        </div>
      </div>
      <div style="text-align:right">
        <div style="font-size:12px">${formatDateISO()}</div>
      </div>
    </div>
  `;
}

function signatureRightHtml(){
  return `
    <div class="signature-right">
      <div>
        <div class="signature-line"></div>
        <div class="signature-caption">Authorized Signature</div>
      </div>
    </div>
  `;
}

/* Build current live bill summary html */
function buildCurrentBillSummaryHtml(){
  const company = appState.company || {};
  const mo = appState.mohajon || {};
  const workersRows = appState.workers.map(w=>{
    const doubles = Number(appState.productionInputs[w.id] || 0);
    const earnings = doubles * Number(w.rate || 0); // rate per double
    const adjustment = Number(w.adjustment || 0);
    const bonus = Number(w.bonus || 0);
    const finalAmount = earnings - adjustment + bonus;
    return `<tr>
      <td>${escapeHtml(w.name)}</td>
      <td>${escapeHtml(w.designation)}</td>
      <td style="text-align:right">${doubles.toFixed(2)}</td>
      <td style="text-align:right">${formatMoney(w.rate)}</td>
      <td style="text-align:right">${formatMoney(earnings)}</td>
      <td style="text-align:right">${formatMoney(adjustment)}</td>
      <td style="text-align:right">${formatMoney(bonus)}</td>
      <td style="text-align:right">${formatMoney(finalAmount)}</td>
    </tr>`;
  }).join('');

  const expElec = Number(appState.expenses.electricity || 0);
  const expMaint = Number(appState.expenses.maintenance || 0);
  const expOther = Number(appState.expenses.other || 0);
  const expTotal = expElec + expMaint + expOther;

  const workersSubtotal = appState.workers.reduce((s,w)=>{
    const doubles = Number(appState.productionInputs[w.id] || 0);
    const earnings = doubles * Number(w.rate || 0);
    return s + (earnings - Number(w.adjustment || 0) + Number(w.bonus || 0));
  },0);

  const income = Number(mo.moneyGiven || 0);
  const net = income - workersSubtotal - expTotal;

  // Mohajon production: if set use it, otherwise compute from machines
  const sumMachineDoubles = (Number(appState.productionInputs['w1']||0) + Number(appState.productionInputs['w2']||0));
  const billProduction = Number(mo.totalProduction || 0) || doublesToPounds(sumMachineDoubles);
  const billAmount = Number(mo.rate || 0) * Number(billProduction || 0);

  const html = `
    <div class="print-page">
      ${companyHeaderHtml(company)}
      <hr style="border:none;border-top:1px solid #000;margin:12px 0" />

      <h3>Mohajon</h3>
      <table>
        <thead><tr><th style="text-align:right">Rate</th><th style="text-align:right">Production (pounds)</th><th style="text-align:right">Bill</th><th style="text-align:right">Money Given</th><th style="text-align:right">Due</th></tr></thead>
        <tbody>
          <tr>
            <td style="text-align:right">${formatMoney(mo.rate||0)}</td>
            <td style="text-align:right">${Number(billProduction||0).toFixed(2)}</td>
            <td style="text-align:right">${formatMoney(billAmount)}</td>
            <td style="text-align:right">${formatMoney(mo.moneyGiven||0)}</td>
            <td style="text-align:right">${formatMoney(billAmount - Number(mo.moneyGiven||0))}</td>
          </tr>
        </tbody>
      </table>

      <h3>Workers</h3>
      <div class="small"><strong>One double = ten pounds.</strong></div>
      <table>
        <thead><tr><th>Worker</th><th>Role</th><th style="text-align:right">Production (double)</th><th>Rate</th><th>Bill</th><th>Adjustment</th><th>Bonus</th><th>Final Amount</th></tr></thead>
        <tbody>${workersRows}</tbody>
        <tfoot>
          <tr>
            <th colspan="7" style="text-align:right">Workers Subtotal</th>
            <th style="text-align:right">${formatMoney(workersSubtotal)}</th>
          </tr>
        </tfoot>
      </table>

      <h3>Expenses</h3>
      <table>
        <thead><tr><th>Electricity</th><th>Maintenance</th><th>Other</th><th>Total</th></tr></thead>
        <tbody>
          <tr>
            <td style="text-align:right">${formatMoney(expElec)}</td>
            <td style="text-align:right">${formatMoney(expMaint)}</td>
            <td style="text-align:right">${formatMoney(expOther)}</td>
            <td style="text-align:right">${formatMoney(expTotal)}</td>
          </tr>
        </tbody>
      </table>

      <h3>Summary</h3>
      <table>
        <thead><tr><th>Income (Money Given)</th><th>Payments</th><th>Expenses</th><th>Net</th></tr></thead>
        <tbody>
          <tr>
            <td style="text-align:right">${formatMoney(income)}</td>
            <td style="text-align:right">${formatMoney(workersSubtotal)}</td>
            <td style="text-align:right">${formatMoney(expTotal)}</td>
            <td style="text-align:right">${formatMoney(net)}</td>
          </tr>
        </tbody>
      </table>

      ${signatureRightHtml()}
    </div>
  `;
  return html;
}

/* Preview current live bill summary */
function previewCurrentLiveBillSummary(){
  const html = buildCurrentBillSummaryHtml();
  openPreviewWindow(html, 'Bill Summary Preview');
}

/* Preview saved summary by index (0 is latest) */
function previewSavedSummary(index){
  const s = appState.summaries && appState.summaries[index];
  if(!s) {
    previewCurrentLiveBillSummary();
    return;
  }
  const company = s.company || {};
  let workersHtml = s.workers.map(w => `
    <tr>
      <td>${escapeHtml(w.name)}</td>
      <td style="text-align:right">${Number(w.doubles).toFixed(2)}</td>
      <td style="text-align:right">${formatMoney(w.rate)}</td>
      <td style="text-align:right">${formatMoney(w.earnings)}</td>
      <td style="text-align:right">${formatMoney(w.adjustment)}</td>
      <td style="text-align:right">${formatMoney(w.bonus)}</td>
      <td style="text-align:right">${formatMoney(w.finalAmount)}</td>
    </tr>
  `).join('');

  const expTotal = (s.expenses.electricity||0) + (s.expenses.maintenance||0) + (s.expenses.other||0);

  const billAmount = Number(s.mohajon.rate || 0) * Number(s.mohajon.totalProduction || 0);

  const html = `
    <div class="print-page">
      ${companyHeaderHtml(company)}
      <hr style="border:none;border-top:1px solid #000;margin:12px 0" />
      <div style="display:flex;justify-content:space-between;align-items:flex-start;">
        <div>
          <div style="font-weight:700">Summary ID: ${escapeHtml(s.id)}</div>
          <div style="font-size:12px">${escapeHtml(s.period)}</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:12px">${escapeHtml(s.date)}</div>
        </div>
      </div>

      <div style="height:12px"></div>

      <h4>Mohajon</h4>
      <table>
        <thead><tr><th style="text-align:right">Rate</th><th style="text-align:right">Production (pounds)</th><th style="text-align:right">Bill</th><th style="text-align:right">Money Given</th><th style="text-align:right">Due</th></tr></thead>
        <tbody>
          <tr>
            <td style="text-align:right">${formatMoney(s.mohajon.rate||0)}</td>
            <td style="text-align:right">${Number(s.mohajon.totalProduction||0).toFixed(2)}</td>
            <td style="text-align:right">${formatMoney(billAmount)}</td>
            <td style="text-align:right">${formatMoney(s.mohajon.moneyGiven||0)}</td>
            <td style="text-align:right">${formatMoney(billAmount - Number(s.mohajon.moneyGiven||0))}</td>
          </tr>
        </tbody>
      </table>

      <h4>Workers</h4>
      <div class="small">Worker production shown as <strong>doubles</strong>. <strong>One double = ten pounds.</strong></div>
      <table>
        <thead><tr><th>Worker</th><th style="text-align:right">Production (double)</th><th style="text-align:right">Rate</th><th style="text-align:right">Earnings</th><th style="text-align:right">Adjustment</th><th style="text-align:right">Bonus</th><th style="text-align:right">Final</th></tr></thead>
        <tbody>${workersHtml}</tbody>
        <tfoot>
          <tr>
            <th colspan="6" style="text-align:right">Workers Subtotal</th>
            <th style="text-align:right">${formatMoney(s.totals.payments)}</th>
          </tr>
        </tfoot>
      </table>

      <div style="height:10px"></div>

      <h4>Expenses</h4>
      <table>
        <thead><tr><th>Electricity</th><th>Maintenance</th><th>Other</th><th>Total</th></tr></thead>
        <tbody>
          <tr>
            <td style="text-align:right">${formatMoney(s.expenses.electricity||0)}</td>
            <td style="text-align:right">${formatMoney(s.expenses.maintenance||0)}</td>
            <td style="text-align:right">${formatMoney(s.expenses.other||0)}</td>
            <td style="text-align:right">${formatMoney(expTotal)}</td>
          </tr>
        </tbody>
      </table>

      <div style="height:10px"></div>

      <h4>Summary</h4>
      <table>
        <thead><tr><th>Income</th><th>Payments</th><th>Expenses</th><th>Net</th></tr></thead>
        <tbody>
          <tr>
            <td style="text-align:right">${formatMoney(s.totals.income)}</td>
            <td style="text-align:right">${formatMoney(s.totals.payments)}</td>
            <td style="text-align:right">${formatMoney(s.totals.expenses)}</td>
            <td style="text-align:right">${formatMoney(s.totals.net)}</td>
          </tr>
        </tbody>
      </table>

      ${signatureRightHtml()}
    </div>
  `;
  openPreviewWindow(html, 'Saved Summary '+s.id);
}

/* Preview invoice summary (Workers list) - "Double" header renamed to "Production (double)" */
function previewInvoiceSummary(invoiceIndex){
  const inv = appState.invoices && appState.invoices[invoiceIndex];
  if(!inv) return alert('Invoice not found.');
  const company = appState.company || {};
  const summary = (appState.summaries || []).find(s => s.id === inv.id) || null;
  const mohajon = summary ? (summary.mohajon || appState.mohajon) : appState.mohajon;

  const workerRows = inv.workers.map(w => `
    <tr>
      <td>${escapeHtml(w.name)}</td>
      <td>${escapeHtml(w.designation)}</td>
      <td style="text-align:right">${Number(w.doubles).toFixed(2)}</td>
      <td style="text-align:right">${formatMoney(w.rate)}</td>
      <td style="text-align:right">${formatMoney(w.bill)}</td>
      <td style="text-align:right">${formatMoney(w.adjustment)}</td>
      <td style="text-align:right">${formatMoney(w.total)}</td>
    </tr>
  `).join('');

  const html = `
    <div class="print-page">
      ${companyHeaderHtml(company)}
      <hr style="border:none;border-top:1px solid #000;margin:12px 0" />
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <div style="font-weight:700">Invoice: ${escapeHtml(inv.id)}</div>
          <div style="font-size:12px">${escapeHtml(inv.period)}</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:12px">${escapeHtml(inv.date)}</div>
        </div>
      </div>

      <div style="height:12px"></div>

      <table>
        <thead><tr>
          <th>Worker</th><th>Role</th><th style="text-align:right">Production (double)</th><th>Rate</th><th>Bill</th><th>Adjustment</th><th>Total</th>
        </tr></thead>
        <tbody>${workerRows}</tbody>
        <tfoot>
          <tr>
            <th colspan="6" style="text-align:right">Total Payments</th>
            <th style="text-align:right">${formatMoney(inv.total)}</th>
          </tr>
        </tfoot>
      </table>

      ${signatureRightHtml()}
    </div>
  `;
  openPreviewWindow(html, 'Invoice '+inv.id);
}

/* Per-worker pages - header uses "Production (double)" */
function previewAllWorkersForInvoice(invoiceIndex){
  const inv = appState.invoices && appState.invoices[invoiceIndex];
  if(!inv) return alert('Invoice not found.');
  const company = appState.company || {};

  const pages = inv.workers.map((w, idx) => {
    return `
      <div class="print-page">
        ${companyHeaderHtml(company)}
        <hr style="border:none;border-top:1px solid #000;margin:12px 0" />
        <div style="display:flex;gap:12px;align-items:center">
          <div>
            <div style="font-weight:700;font-size:16px">${escapeHtml(w.name)}</div>
            <div style="font-size:12px">${escapeHtml(w.designation || '')}</div>
          </div>
          <div style="margin-left:auto;text-align:right">
            <div style="font-size:12px">Invoice: <strong>${escapeHtml(inv.id)}</strong></div>
            <div style="font-size:12px">${escapeHtml(inv.date)}</div>
            <div style="font-size:12px">${escapeHtml(inv.period)}</div>
          </div>
        </div>

        <div style="height:12px"></div>

        <table>
          <thead><tr><th>Designation</th><th>Rate (৳/double)</th><th style="text-align:right">Production (double)</th><th>Bill</th></tr></thead>
          <tbody>
            <tr>
              <td>${escapeHtml(w.designation || '')}</td>
              <td style="text-align:right">${formatMoney(w.rate)}</td>
              <td style="text-align:right">${Number(w.doubles||0).toFixed(2)}</td>
              <td style="text-align:right">${formatMoney(w.bill)}</td>
            </tr>
            <tr>
              <td colspan="3">Adjustment</td>
              <td style="text-align:right">${formatMoney(w.adjustment)}</td>
            </tr>
            <tr>
              <td colspan="3">Bonus</td>
              <td style="text-align:right">${formatMoney(w.bonus)}</td>
            </tr>
            <tr>
              <th colspan="3" style="text-align:right">Total</th>
              <th class="invoice-total" style="text-align:right">${formatMoney(w.total)}</th>
            </tr>
          </tbody>
        </table>

        ${signatureRightHtml()}
      </div>
      ${idx < inv.workers.length-1 ? '<div class="page-break"></div>' : ''}
    `;
  }).join('');

  openPreviewWindow(pages, 'Per-Worker Invoices (Combined)');
}

/* Mohajon receipt unchanged except labels; Mohajon production is pounds */
function previewMohajonReceipt(invoiceIndex){
  const inv = appState.invoices && appState.invoices[invoiceIndex];
  if(!inv) return alert('Invoice not found.');
  const company = appState.company || {};
  const summary = (appState.summaries || []).find(s => s.id === inv.id) || null;
  const mo = summary ? (summary.mohajon || appState.mohajon) : appState.mohajon;
  const receiptNo = onlyDigits('RCPT-' + inv.id);

  const html = `
    <div class="print-page">
      ${companyHeaderHtml(company)}
      <hr style="border:none;border-top:1px solid #000;margin:12px 0" />

      <div style="text-align:center;margin-bottom:8px">
        <h3 style="margin:0">Receipt</h3>
        <div style="font-size:12px">Receipt No: <strong>${receiptNo}</strong></div>
      </div>

      <div style="display:flex;gap:24px;flex-wrap:wrap">
        <div style="flex:1;min-width:180px">
          <strong>Paid By (Mohajon)</strong><br/>
          <div style="margin-top:6px">${escapeHtml(mo.company||'')}</div>
          <div style="font-size:12px;margin-top:6px">${escapeHtml(mo.address||'')}</div>
          <div style="font-size:12px">${escapeHtml(mo.phone||'')}</div>
        </div>
        <div style="flex:1;min-width:180px;text-align:right">
          <strong>Received By (Company)</strong><br/>
          <div style="margin-top:6px">${escapeHtml(company.name||'')}</div>
          <div style="font-size:12px;margin-top:6px">${escapeHtml(company.address||'')}</div>
          <div style="font-size:12px">${escapeHtml(company.phone||'')}</div>
        </div>
      </div>

      <div style="height:12px"></div>

      <!-- Mohajon columns (Receipt includes Bill) -->
      <table>
        <thead><tr><th style="text-align:right">Rate</th><th style="text-align:right">Production (pounds)</th><th style="text-align:right">Bill</th><th style="text-align:right">Money Given</th><th style="text-align:right">Due</th></tr></thead>
        <tbody>
          <tr>
            <td style="text-align:right">${formatMoney(mo.rate)}</td>
            <td style="text-align:right">${Number(mo.totalProduction||0).toFixed(2)}</td>
            <td style="text-align:right">${formatMoney(Number(mo.rate||0)*Number(mo.totalProduction||0))}</td>
            <td style="text-align:right">${formatMoney(mo.moneyGiven||0)}</td>
            <td style="text-align:right">${formatMoney((Number(mo.rate||0)*Number(mo.totalProduction||0)) - Number(mo.moneyGiven||0))}</td>
          </tr>
        </tbody>
      </table>

      ${signatureRightHtml()}
    </div>
  `;
  openPreviewWindow(html, 'Mohajon Receipt');
}

/* ---------------------------
   Delete helpers
   --------------------------- */
function confirmDeleteInvoice(index){
  showDeleteConfirm('Delete this weekly invoice and its worker history entries?', ()=>{
    const inv = appState.invoices[index];
    if(inv && inv.workers){
      inv.workers.forEach(w=>{
        const hist = appState.billingHistory[w.id] || [];
        const idx = hist.findIndex(h => (h.invoiceId && h.invoiceId === inv.id));
        if(idx >= 0) hist.splice(idx,1);
      });
    }
    appState.invoices.splice(index,1);
    saveState();
  });
}

/* ---------------------------
   Expenses sync
   --------------------------- */
function renderExpenses(){
  document.getElementById('expense-electricity').value = Number(appState.expenses.electricity||0).toFixed(2);
  document.getElementById('expense-maintenance').value = Number(appState.expenses.maintenance||0).toFixed(2);
  document.getElementById('expense-other').value = Number(appState.expenses.other||0).toFixed(2);
}

/* ---------------------------
   Dashboard Weekly Summary button wiring
   --------------------------- */
function previewSummaryForInvoice(invoiceIndex){
  const inv = appState.invoices && appState.invoices[invoiceIndex];
  if(!inv) return alert('Invoice not found.');
  const sIndex = (appState.summaries || []).findIndex(s => s.id === inv.id);
  if(sIndex >= 0){
    previewSavedSummary(sIndex);
  } else {
    previewCurrentLiveBillSummary();
  }
}

/* ---------------------------
   Startup
   --------------------------- */
renderAll();
applyCompanyHeader();
populateSettingsForm();

</script>
</body>
</html>
