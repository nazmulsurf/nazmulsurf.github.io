<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Billing & Production — Nazmul Twisting Mill</title>

<!-- Default favicon (user-specified name: assets/favicon.png) -->
<link id="favico" rel="icon" href="assets/favicon.png" type="image/png" />

<style>
  :root{
    --bg: #ffffff;
    --panel: #f5f5f5;
    --text: #101010;
    --muted: #6b6b6b;
    --accent: #000000;
    --radius: 10px;
    --btn-radius: 8px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:var(--bg);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    padding:18px;
  }
  .container{max-width:1150px;margin:0 auto}
  header{
    background:var(--accent);
    color: #fff;
    padding:18px;
    border-radius:var(--radius);
    margin-bottom:16px;
    text-align:center;
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:center;
  }
  header h1{margin:0;font-size:20px;font-weight:600}
  header p{margin:2px 0;font-size:13px;opacity:.9}
  header .logo{width:56px;height:56px;border-radius:8px;overflow:hidden;background:#fff;display:flex;align-items:center;justify-content:center}
  header .logo img{max-width:48px;max-height:48px;display:block}

  .nav{
    display:flex;
    gap:8px;
    margin:14px 0 20px;
    flex-wrap:wrap;
  }
  .nav button{
    background:#fff;
    color:var(--text);
    border:1px solid #dcdcdc;
    padding:8px 12px;
    border-radius:var(--btn-radius);
    cursor:pointer;
    font-weight:600;
    font-size:13px;
  }
  .nav button.active{
    background:var(--accent);
    color:#fff;
    border-color:var(--accent);
  }

  .page{display:none;background:var(--panel);padding:16px;border-radius:var(--radius);margin-bottom:18px}
  .page.active{display:block}

  h2{margin-top:0;margin-bottom:8px;font-size:18px}
  p.lead{margin-top:0;margin-bottom:12px;color:var(--muted)}

  .grid {
    display:grid;
    gap:12px;
  }
  .grid.cols-2{grid-template-columns:repeat(2,1fr)}
  .grid.cols-3{grid-template-columns:repeat(3,1fr)}
  .grid.cols-4{grid-template-columns:repeat(4,1fr)}
  .card{
    background:#fff;border-radius:8px;padding:12px;border:1px solid #eee;
  }

  label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
  input[type="number"], input[type="text"], input[type="password"], textarea{
    width:100%;
    padding:8px 10px;
    border-radius:6px;
    border:1px solid #ddd;
    font-size:14px;
  }

  .small {font-size:13px;color:var(--muted)}

  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:10px;border:1px solid #eee;text-align:left;font-size:14px}
  th{background:#fafafa;font-weight:700;color:var(--muted);text-transform:uppercase;font-size:12px}
  tfoot th{font-weight:700}

  .btn { display:inline-block; padding:8px 12px; border-radius:var(--btn-radius); border:1px solid #111; background:#111; color:#fff; cursor:pointer; font-weight:600; font-size:13px; }
  .btn.secondary{ background:#fff; color:#111; border:1px solid #111; }
  .btn.ghost{ background:transparent; color:#111; border:1px solid #ccc; }
  .btn.restore{ background:#fff; color:#111; border:1px dashed #bbb; }
  .btn.small{ padding:6px 8px; font-size:13px; }
  .muted{ color:var(--muted) }

  .worker-pills{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px }
  .pill{ padding:8px 12px; border-radius:40px; background:#fff; border:1px solid #ddd; cursor:pointer; display:flex; align-items:center; gap:8px; font-weight:600 }
  .pill.active{ background:var(--accent); color:#fff; border-color:var(--accent) }

  .actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px }

  .modal{ position:fixed; inset:0; background:rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; z-index:40 }
  .modal .box{ background:#fff; padding:18px; border-radius:10px; width:96%; max-width:420px; box-shadow:0 8px 30px rgba(0,0,0,0.12) }

  /* signature */
  #signature-area{margin-top:18px;display:flex;gap:40px;justify-content:flex-end;align-items:flex-end;}
  .signature-box{text-align:center;width:200px;}
  .signature-line{border-top:1px solid #000;margin-top:48px;height:2px;width:100%}

  @media (max-width:860px){
    .grid.cols-2{ grid-template-columns:1fr }
    .grid.cols-4{ grid-template-columns:repeat(2,1fr) }
  }

  /* Print control: show only printable area */
  @media print{
    body * { visibility: hidden !important; }
    .printable, .printable * { visibility: visible !important; }
    .printable { position: absolute; left: 0; top: 0; width: 100%; }
  }

  .muted-small{ color:var(--muted); font-size:13px }
  .company-header { display:flex; gap:12px; align-items:center; margin-bottom:8px; }
  .company-header img { width:72px; height:72px; border-radius:8px; object-fit:contain; }
  .settings-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  @media (max-width:860px){ .settings-grid{ grid-template-columns:1fr } }

</style>
</head>
<body>
<div class="container">

  <header>
    <div class="logo">
      <img id="header-logo" src="assets/favicon.png" alt="Company logo" onerror="this.style.display='none'"/>
    </div>
    <div style="text-align:left">
      <h1 id="header-name">Nazmul Twisting Mill Ltd — Billing & Production</h1>
      <p class="small" id="header-contact">Old Bogura Road, Telkupi — Phone: (+880) 1766759293 — Email: nazmul.fig@gmail.com</p>
    </div>
  </header>

  <nav class="nav" role="navigation" aria-label="Main">
    <button class="nav-btn active" data-page="dashboard">Dashboard</button>
    <button class="nav-btn" data-page="workers">Workers</button>
    <button class="nav-btn" data-page="production">Production</button>
    <button class="nav-btn" data-page="rates">Rates</button>
    <button class="nav-btn" data-page="expenses">Expenses</button>
    <button class="nav-btn" data-page="bill-summary">Bill Summary</button>
    <button class="nav-btn" data-page="settings">Settings</button>
  </nav>

  <!-- DASHBOARD -->
  <section id="dashboard" class="page active">
    <h2>Dashboard</h2>
    <p class="lead">Summary and histories</p>

    <div class="grid cols-4">
      <div class="card">
        <div class="small">Revenue from Mohajon</div>
        <div id="summary-mohajon" style="font-weight:700;font-size:20px">৳0.00</div>
      </div>
      <div class="card">
        <div class="small">Total Worker Payments</div>
        <div id="summary-workers" style="font-weight:700;font-size:20px">৳0.00</div>
      </div>
      <div class="card">
        <div class="small">Total Expenses</div>
        <div id="summary-expenses" style="font-weight:700;font-size:20px">৳0.00</div>
      </div>
      <div class="card">
        <div class="small">Weekly Profit</div>
        <div id="summary-profit" style="font-weight:700;font-size:20px">৳0.00</div>
      </div>
    </div>

    <div style="margin-top:14px">
      <h3 style="margin-bottom:10px">Weekly Invoice History</h3>
      <div id="weekly-invoices-list">
        <table id="weekly-invoices-table">
          <thead><tr><th>Invoice #</th><th>Date</th><th>Period</th><th>Total</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div style="margin-top:18px">
      <h3 style="margin-bottom:10px">Saved Bill Summaries</h3>
      <div id="saved-summaries-list" class="card">
        <table id="saved-summaries-table">
          <thead><tr><th>Summary ID</th><th>Date</th><th>Period</th><th>Total Income</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </section>

  <!-- WORKERS -->
  <section id="workers" class="page">
    <h2>Workers</h2>
    <p class="lead">Edit worker names inline. Press <strong>Save Names</strong> to confirm changes and update everywhere.</p>

    <div class="card">
      <div class="worker-pills" id="worker-pills"></div>

      <div style="margin-top:12px">
        <table>
          <thead><tr><th>Worker #</th><th>Name (editable)</th></tr></thead>
          <tbody id="workers-edit-table"></tbody>
        </table>
        <div class="actions" style="margin-top:10px">
          <button class="btn" id="save-names-btn">Save Names</button>
        </div>
      </div>

      <div style="margin-top:14px">
        <h4 style="margin:0 0 8px 0">Selected Worker Details</h4>
        <div id="worker-details-area" class="card">
          <!-- Filled dynamically -->
        </div>
      </div>
    </div>
  </section>

  <!-- PRODUCTION -->
  <section id="production" class="page">
    <h2>Production Input</h2>
    <p class="lead">Calculate Mohajon and Weekly production. Rates in the Rates menu are used for production calculations and update when you press <strong>Set Rates</strong>.</p>

    <div class="grid cols-2">
      <!-- Mohajon -->
      <div class="card">
        <h4 style="margin:0 0 8px 0">Mohajon Calculation</h4>
        <label>Mohajon Rate (৳ per pound)</label>
        <input type="number" id="mohajon-rate" step="0.01" value="0" min="0" />

        <label style="margin-top:8px">Total Machine Production (pounds)</label>
        <input type="number" id="mohajon-total-production" step="0.01" value="0" min="0" />

        <div class="actions">
          <button class="btn" id="calc-mohajon-btn">Calculate Mohajon</button>
          <button class="btn restore" id="restore-mohajon-btn">Restore Mohajon</button>
        </div>

        <div style="margin-top:12px">
          <div class="small">Amount from Mohajon</div>
          <div id="mohajon-amount" style="font-weight:700; font-size:18px">৳0.00</div>
        </div>
      </div>

      <!-- Weekly Production Calculation -->
      <div class="card">
        <h4 style="margin:0 0 8px 0">Weekly Production Calculation</h4>

        <div style="margin-bottom:8px" class="small">Enter pounds and adjustments for each worker</div>
        <table>
          <thead><tr><th>Worker</th><th>Role</th><th>Pounds</th><th>Adjustment</th><th>Rate (৳/pound)</th><th>Earnings (after adj.)</th></tr></thead>
          <tbody id="production-workers-body"></tbody>
          <tfoot>
            <tr>
              <th colspan="5" style="text-align:right">This Week Total</th>
              <th id="this-week-total">৳0.00</th>
            </tr>
          </tfoot>
        </table>

        <div class="actions">
          <button class="btn" id="calc-weekly-btn">Calculate Weekly</button>
          <button class="btn restore" id="restore-weekly-btn">Restore Weekly</button>
        </div>
      </div>
    </div>

    <div style="margin-top:12px">
      <button class="btn" id="switch-to-billsummary">Generate Bill Summary (go to Bill Summary page)</button>
    </div>
  </section>

  <!-- RATES -->
  <section id="rates" class="page">
    <h2>Rates</h2>
    <p class="lead">Default rates are zero. Editing rates here updates production automatically; press <strong>Set Rates</strong> to commit and save.</p>

    <div class="card">
      <table>
        <thead><tr><th>Worker</th><th>Current Rate (৳ / pound)</th></tr></thead>
        <tbody id="rates-table-body"></tbody>
      </table>
      <div class="actions" style="margin-top:10px">
        <button class="btn" id="set-rates-btn">Set Rates</button>
        <button class="btn secondary" id="restore-rate-defaults">Reset Rates to 0</button>
      </div>
    </div>
  </section>

  <!-- EXPENSES -->
  <section id="expenses" class="page">
    <h2>Expenses</h2>
    <p class="lead">Expenses update only when you press <strong>Update Expenses</strong>.</p>

    <div class="card">
      <div class="grid cols-2">
        <div>
          <label>Electricity (৳)</label>
          <input type="number" id="expense-electricity" value="0" min="0" step="0.01" />
        </div>
        <div>
          <label>Maintenance (৳)</label>
          <input type="number" id="expense-maintenance" value="0" min="0" step="0.01" />
        </div>
        <div>
          <label>Other (৳)</label>
          <input type="number" id="expense-other" value="0" min="0" step="0.01" />
        </div>
        <div>
          <label>&nbsp;</label>
          <div class="actions">
            <button class="btn" id="update-expenses-btn">Update Expenses</button>
            <button class="btn secondary" id="restore-expenses-btn">Restore Expenses</button>
          </div>
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="small">Total Expenses</div>
        <div id="expenses-total" style="font-weight:700;font-size:18px">৳0.00</div>
      </div>
    </div>
  </section>

  <!-- BILL SUMMARY -->
  <section id="bill-summary" class="page">
    <h2>Bill Summary</h2>
    <p class="lead">A printable summary that includes Mohajon, worker production, expenses and net revenue. Save summaries to the dashboard for later download or printing.</p>

    <div class="card printable" id="bill-summary-card">
      <div class="company-header">
        <img id="bs-logo" src="assets/favicon.png" alt="logo" onerror="this.style.display='none'"/>
        <div>
          <div style="font-weight:700" id="company-name-display">Nazmul Twisting Mill Ltd</div>
          <div class="muted-small" id="company-address-display">Old Bogura Road, Telkupi</div>
          <div class="muted-small" id="company-contact-display">Phone: (+880) 1766759293 — Email: nazmul.fig@gmail.com</div>
        </div>
      </div>

      <h3 style="margin-top:0">Mohajon</h3>
      <table>
        <thead><tr><th>Rate (৳/pound)</th><th>Total Production (pounds)</th><th>Total Amount (৳)</th></tr></thead>
        <tbody>
          <tr>
            <td id="bs-mohajon-rate">৳0.00</td>
            <td id="bs-total-production">0.00</td>
            <td id="bs-total-amount">৳0.00</td>
          </tr>
        </tbody>
      </table>

      <h3 style="margin-top:12px">Workers Production</h3>
      <table>
        <thead><tr><th>Worker</th><th>Role</th><th>Pounds</th><th>Rate</th><th>Earnings</th><th>Adjustment</th><th>Final Amount</th></tr></thead>
        <tbody id="bill-summary-workers-body"></tbody>
        <tfoot>
          <tr>
            <th colspan="6" style="text-align:right">Subtotal</th>
            <th id="bs-workers-subtotal">৳0.00</th>
          </tr>
        </tfoot>
      </table>

      <h3 style="margin-top:12px">Expenses</h3>
      <table>
        <thead><tr><th>Electricity</th><th>Maintenance</th><th>Other</th><th>Total</th></tr></thead>
        <tbody>
          <tr>
            <td id="bs-exp-elec">৳0.00</td>
            <td id="bs-exp-maint">৳0.00</td>
            <td id="bs-exp-other">৳0.00</td>
            <td id="bs-exp-total">৳0.00</td>
          </tr>
        </tbody>
      </table>

      <h3 style="margin-top:12px">Summary</h3>
      <table>
        <thead><tr><th>Income</th><th>Payments to Workers</th><th>Expenses</th><th>Net Revenue</th></tr></thead>
        <tbody>
          <tr>
            <td id="bs-income">৳0.00</td>
            <td id="bs-payments">৳0.00</td>
            <td id="bs-expenses">৳0.00</td>
            <td id="bs-net">৳0.00</td>
          </tr>
        </tbody>
      </table>

      <div class="actions" style="margin-top:12px">
        <button class="btn" id="print-summary-btn">Print Summary</button>
        <button class="btn secondary" id="save-summary-btn">Save Summary</button>
      </div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="settings" class="page">
    <h2>Settings</h2>
    <p class="lead">Update company details and site settings. Uploaded logo images will be saved and used as the site favicon and logo in printouts.</p>

    <div class="card">
      <div class="settings-grid">
        <div>
          <label>Company Name</label>
          <input type="text" id="setting-company-name" />

          <label style="margin-top:8px">Address</label>
          <textarea id="setting-company-address" rows="2"></textarea>

          <label style="margin-top:8px">Phone</label>
          <input type="text" id="setting-company-phone" />

          <label style="margin-top:8px">Email</label>
          <input type="text" id="setting-company-email" />
        </div>

        <div>
          <label>Logo path (type a path like <code>assets/favicon.png</code>)</label>
          <input type="text" id="setting-company-logo-path" placeholder="assets/favicon.png" />

          <label style="margin-top:8px">Or upload a logo image (jpg/png)</label>
          <input type="file" id="setting-company-logo-file" accept="image/*" />

          <div style="margin-top:12px">
            <label>Current Favicon Preview</label>
            <div style="display:flex;gap:12px;align-items:center;margin-top:8px">
              <img id="settings-logo-preview" src="assets/favicon.png" alt="logo preview" style="width:72px;height:72px;object-fit:contain;border-radius:8px" onerror="this.style.display='none'"/>
              <div class="muted-small" id="settings-current-logo-path">assets/favicon.png</div>
            </div>
          </div>
        </div>
      </div>

      <div style="margin-top:14px">
        <h4>Password & Security</h4>
        <label>Current delete password (masked)</label>
        <input type="password" id="setting-delete-password-current" placeholder="Enter current to change" />

        <label style="margin-top:8px">New delete password</label>
        <input type="password" id="setting-delete-password-new" placeholder="Leave blank to keep same" />

        <div class="small" style="margin-top:8px">Note: This password is required when deleting saved summaries, invoices, or worker history entries.</div>

        <div class="actions" style="margin-top:12px">
          <button class="btn" id="save-settings-btn">Save Settings</button>
          <button class="btn secondary" id="reset-defaults-btn">Reset App to Defaults</button>
        </div>
      </div>
    </div>
  </section>

</div>

<!-- Hidden: area used to render single-worker invoice for printing -->
<div id="worker-invoice-area" style="display:none"></div>

<!-- Modal: confirm delete (not used for password prompt fallback) -->
<div class="modal" id="confirm-modal">
  <div class="box">
    <div id="confirm-text">Are you sure?</div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button class="btn secondary" id="confirm-cancel">Cancel</button>
      <button class="btn" id="confirm-ok">OK</button>
    </div>
  </div>
</div>

<script>
/* ---------------------------
   App data model + persistence
   --------------------------- */
const STORAGE_KEY = 'ntm_app_v2';

const defaultState = () => ({
  company: {
    name: 'Nazmul Twisting Mill Ltd',
    address: 'Old Bogura Road, Telkupi',
    phone: '(+880) 1766759293',
    email: 'nazmul.fig@gmail.com',
    logo: 'assets/favicon.png' // default to user's favicon name
  },
  deletePassword: '1234', // default password (configurable)
  workers: [
    { id: 'w1', name: 'Name_1', role: 'Machine', rate: 0, adjustments: 0 },
    { id: 'w2', name: 'Name_2', role: 'Machine', rate: 0, adjustments: 0 },
    { id: 'w3', name: 'Name_3', role: 'Drum', rate: 0, adjustments: 0 },
    { id: 'w4', name: 'Name_4', role: 'Drum', rate: 0, adjustments: 0 },
    { id: 'w5', name: 'Name_5', role: 'Kun', rate: 0, adjustments: 0 }
  ],
  ratesSavedAt: null,
  productionInputs: { 'w1': 0, 'w2': 0, 'w3': 0, 'w4': 0, 'w5': 0 },
  mohajon: { rate: 0, totalProduction: 0, amount: 0 },
  expenses: { electricity: 0, maintenance: 0, other: 0 },
  invoices: [],
  billingHistory: { 'w1': [], 'w2': [], 'w3': [], 'w4': [], 'w5': [] },
  summaries: []
});

let appState = loadState() || defaultState();

/* ---------------------------
   Utility functions
   --------------------------- */
function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
  renderAll();
}
function loadState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw ? JSON.parse(raw) : null;
  } catch(e) {
    console.error('Failed to load state', e);
    return null;
  }
}
function resetStateToDefaults() {
  if(!confirm('Reset the entire app to defaults? This will remove saved summaries and settings.')) return;
  appState = defaultState();
  saveState();
  // reload to reflect favicon reset
  location.reload();
}

/* update favicon <link> */
function updateFavicon(url){
  const link = document.getElementById('favico') || document.querySelector('link[rel="icon"]');
  if(link){
    link.href = url;
  } else {
    const l = document.createElement('link');
    l.id = 'favico';
    l.rel = 'icon';
    l.href = url;
    l.type = 'image/png';
    document.head.appendChild(l);
  }
}

/* ---------------------------
   Navigation
   --------------------------- */
document.querySelectorAll('.nav-btn').forEach(btn=>{
  btn.addEventListener('click', () => {
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const page = btn.dataset.page;
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    const el = document.getElementById(page);
    if(el) el.classList.add('active');
    if(page === 'bill-summary') renderBillSummary();
    if(page === 'settings') populateSettingsForm();
  });
});

/* ---------------------------
   Render functions
   --------------------------- */
function renderAll() {
  renderDashboard();
  renderWorkers();
  renderProductionInputs();
  renderRatesTable();
  renderExpenses();
  renderBillSummary();
  renderWeeklyInvoicesTable();
  renderSavedSummariesTable();
  applyCompanyHeader();
}
function formatMoney(n){ return '৳' + Number(n || 0).toFixed(2); }
function formatDateISO(d=new Date()){ return d.toLocaleDateString() + ' ' + d.toLocaleTimeString(); }
function getWeekPeriodText(d=new Date()){
  const end = new Date(d);
  const start = new Date(d);
  start.setDate(end.getDate() - 6);
  return `${start.toLocaleDateString()} - ${end.toLocaleDateString()}`;
}

/* Apply company info to header & print sections */
function applyCompanyHeader(){
  const c = appState.company || {};
  const headerName = document.getElementById('header-name');
  const headerContact = document.getElementById('header-contact');
  const headerLogo = document.getElementById('header-logo');
  const bsLogo = document.getElementById('bs-logo');
  const compName = document.getElementById('company-name-display');
  const compAddr = document.getElementById('company-address-display');
  const compContact = document.getElementById('company-contact-display');

  if(headerName) headerName.textContent = (c.name || 'Company') + ' — Billing & Production';
  if(headerContact) headerContact.textContent = `${c.address || ''} — Phone: ${c.phone || ''} — Email: ${c.email || ''}`;
  if(headerLogo) { headerLogo.src = c.logo || ''; headerLogo.style.display = c.logo ? '' : 'none'; }
  if(bsLogo) { bsLogo.src = c.logo || ''; bsLogo.style.display = c.logo ? '' : 'none'; }
  if(compName) compName.textContent = c.name || '';
  if(compAddr) compAddr.textContent = c.address || '';
  if(compContact) compContact.textContent = `Phone: ${c.phone || ''} — Email: ${c.email || ''}`;

  // update favicon link
  if(c.logo) updateFavicon(c.logo);
}

/* DASHBOARD */
function renderDashboard(){
  const mohajonAmt = appState.mohajon.amount || 0;
  const totalWorkersPaid = computeWorkersTotalPaid();
  const expensesTotal = (appState.expenses.electricity||0) + (appState.expenses.maintenance||0) + (appState.expenses.other||0);
  const profit = mohajonAmt - totalWorkersPaid - expensesTotal;
  document.getElementById('summary-mohajon').textContent = formatMoney(mohajonAmt);
  document.getElementById('summary-workers').textContent = formatMoney(totalWorkersPaid);
  document.getElementById('summary-expenses').textContent = formatMoney(expensesTotal);
  document.getElementById('summary-profit').textContent = formatMoney(profit);
}

/* WORKERS */
function renderWorkers(){
  // pills
  const pillContainer = document.getElementById('worker-pills');
  pillContainer.innerHTML = '';
  appState.workers.forEach((w, idx) => {
    const div = document.createElement('div');
    div.className = 'pill' + (idx===0 ? ' active' : '');
    div.dataset.workerId = w.id;
    div.innerHTML = `<span class="pill-name">${escapeHtml(w.name)}</span>`;
    div.addEventListener('click', () => {
      document.querySelectorAll('.pill').forEach(p=>p.classList.remove('active'));
      div.classList.add('active');
      showWorkerDetails(w.id);
    });
    pillContainer.appendChild(div);
  });

  // edit table
  const tbody = document.getElementById('workers-edit-table');
  tbody.innerHTML = '';
  appState.workers.forEach((w, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="width:85px">${idx+1}</td>
      <td contenteditable="true" class="worker-name-edit" data-worker-id="${w.id}">${escapeHtml(w.name)}</td>
    `;
    tbody.appendChild(tr);
  });

  // show first worker details by default
  showWorkerDetails(appState.workers[0].id);
}

/* show a selected worker's details and history */
function showWorkerDetails(workerId){
  const w = appState.workers.find(x=>x.id===workerId);
  const area = document.getElementById('worker-details-area');
  const history = appState.billingHistory[workerId] || [];
  let html = `<div class="small">Name</div><div style="font-weight:700">${escapeHtml(w.name)} (${w.role})</div>`;
  html += `<div style="margin-top:8px"><div class="small">Rate</div><div>${formatMoney(w.rate)}/pound</div></div>`;
  html += `<div style="margin-top:8px"><div class="small">Adjustments (current)</div><div>${formatMoney(w.adjustments)}</div></div>`;
  html += `<div style="margin-top:10px"><h4 style="margin:6px 0">Billing History</h4>`;
  if(history.length === 0) html += '<div class="small">No history yet</div>';
  else {
    html += `<table><thead><tr><th>Date</th><th>Pounds</th><th>Earnings</th><th>Adjustment</th><th>Total</th><th>Actions</th></tr></thead><tbody>`;
    history.forEach((rec, idx) => {
      html += `<tr>
        <td>${escapeHtml(rec.date)}</td>
        <td>${rec.pounds}</td>
        <td>${formatMoney(rec.earnings)}</td>
        <td>${formatMoney(rec.adjustments)}</td>
        <td>${formatMoney(rec.total)}</td>
        <td>
          <button class="btn small secondary" onclick="deleteWorkerHistory('${workerId}', ${idx})">Delete</button>
          <button class="btn small" onclick="printWorkerInvoice('${workerId}', ${idx})">Print</button>
        </td>
      </tr>`;
    });
    html += '</tbody></table>';
  }
  html += '</div>';
  area.innerHTML = html;
}

/* PRODUCTION */
function renderProductionInputs(){
  const tbody = document.getElementById('production-workers-body');
  tbody.innerHTML = '';
  appState.workers.forEach(w => {
    const tr = document.createElement('tr');
    const poundsVal = appState.productionInputs[w.id] || 0;
    const adjustmentVal = Number(w.adjustments || 0).toFixed(2);
    tr.innerHTML = `
      <td>${escapeHtml(w.name)}</td>
      <td>${escapeHtml(w.role)}</td>
      <td><input type="number" class="prod-pounds" data-worker="${w.id}" min="0" step="0.01" value="${poundsVal}" /></td>
      <td><input type="number" class="prod-adjust" data-worker="${w.id}" step="0.01" value="${adjustmentVal}" /></td>
      <td class="prod-rate" data-worker="${w.id}">${formatMoney(w.rate)}</td>
      <td class="prod-earnings" data-worker="${w.id}">${formatMoney(0)}</td>
    `;
    tbody.appendChild(tr);
  });

  // wire up inputs to update internal model as user types (only update stored inputs; earnings calc happens on button)
  document.querySelectorAll('.prod-pounds').forEach(inp=>{
    inp.addEventListener('input', e=>{
      const id = inp.dataset.worker;
      const v = parseFloat(inp.value) || 0;
      appState.productionInputs[id] = v;
      // update total machine production for convenience
      const total = Object.values(appState.productionInputs).reduce((s,x)=>s+(Number(x)||0),0);
      document.getElementById('mohajon-total-production').value = total;
    });
  });

  // adjustments inputs
  document.querySelectorAll('.prod-adjust').forEach(inp=>{
    inp.addEventListener('input', e=>{
      const id = inp.dataset.worker;
      const v = parseFloat(inp.value) || 0;
      const w = appState.workers.find(x=>x.id===id);
      if(w) w.adjustments = v;
    });
  });

  // update rates column (in case rates changed)
  document.querySelectorAll('.prod-rate').forEach(td=>{
    const id = td.dataset.worker;
    const w = appState.workers.find(x=>x.id===id);
    td.textContent = formatMoney(w.rate);
  });
}

/* RATES */
function renderRatesTable(){
  const tbody = document.getElementById('rates-table-body');
  tbody.innerHTML = '';
  appState.workers.forEach(w=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(w.name)}</td>
      <td>
        <input type="number" class="rate-input" data-worker="${w.id}" min="0" step="0.01" value="${Number(w.rate).toFixed(2)}" />
      </td>
    `;
    tbody.appendChild(tr);
  });

  // wire up change handler: live preview updates production rates (value not saved until Set Rates is pressed)
  document.querySelectorAll('.rate-input').forEach(inp=>{
    inp.addEventListener('input', e=>{
      const id = inp.dataset.worker;
      const v = parseFloat(inp.value) || 0;
      // temporarily update display in production table
      document.querySelectorAll('.prod-rate').forEach(td=>{
        if(td.dataset.worker === id) td.textContent = formatMoney(v);
      });
    });
  });
}

/* EXPENSES */
function renderExpenses(){
  document.getElementById('expense-electricity').value = Number(appState.expenses.electricity || 0).toFixed(2);
  document.getElementById('expense-maintenance').value = Number(appState.expenses.maintenance || 0).toFixed(2);
  document.getElementById('expense-other').value = Number(appState.expenses.other || 0).toFixed(2);
  const totalExp = (appState.expenses.electricity||0) + (appState.expenses.maintenance||0) + (appState.expenses.other||0);
  document.getElementById('expenses-total').textContent = formatMoney(totalExp);
  // also reflect in dashboard summary-expenses
  document.getElementById('summary-expenses').textContent = formatMoney(totalExp);
}

/* BILL SUMMARY rendering */
function renderBillSummary(){
  // Fill Mohajon
  document.getElementById('bs-mohajon-rate').textContent = formatMoney(appState.mohajon.rate || 0);
  document.getElementById('bs-total-production').textContent = (Number(appState.mohajon.totalProduction || 0)).toFixed(2);
  document.getElementById('bs-total-amount').textContent = formatMoney(appState.mohajon.amount || 0);

  // Fill workers table and compute workers subtotal
  const tbody = document.getElementById('bill-summary-workers-body');
  tbody.innerHTML = '';
  let workersSubtotal = 0;
  appState.workers.forEach(w=>{
    const pounds = Number(appState.productionInputs[w.id] || 0);
    const earnings = pounds * Number(w.rate || 0);
    const adjustment = Number(w.adjustments || 0);
    const finalAmount = earnings - adjustment;
    workersSubtotal += finalAmount;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(w.name)}</td>
      <td>${escapeHtml(w.role)}</td>
      <td>${pounds}</td>
      <td>${formatMoney(w.rate)}</td>
      <td>${formatMoney(earnings)}</td>
      <td>${formatMoney(adjustment)}</td>
      <td>${formatMoney(finalAmount)}</td>
    `;
    tbody.appendChild(tr);
  });
  document.getElementById('bs-workers-subtotal').textContent = formatMoney(workersSubtotal);

  // Fill expenses
  const expElec = Number(appState.expenses.electricity || 0);
  const expMaint = Number(appState.expenses.maintenance || 0);
  const expOther = Number(appState.expenses.other || 0);
  const expTotal = expElec + expMaint + expOther;
  document.getElementById('bs-exp-elec').textContent = formatMoney(expElec);
  document.getElementById('bs-exp-maint').textContent = formatMoney(expMaint);
  document.getElementById('bs-exp-other').textContent = formatMoney(expOther);
  document.getElementById('bs-exp-total').textContent = formatMoney(expTotal);

  // Summary: Income, Payments, Expenses, Net
  const income = Number(appState.mohajon.amount || 0);
  const payments = workersSubtotal;
  const net = income - payments - expTotal;
  document.getElementById('bs-income').textContent = formatMoney(income);
  document.getElementById('bs-payments').textContent = formatMoney(payments);
  document.getElementById('bs-expenses').textContent = formatMoney(expTotal);
  document.getElementById('bs-net').textContent = formatMoney(net);
}

/* Weekly invoices (dashboard) */
function renderWeeklyInvoicesTable(){
  const tbody = document.querySelector('#weekly-invoices-table tbody');
  tbody.innerHTML = '';
  (appState.invoices || []).forEach((inv, idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(inv.id)}</td>
      <td>${escapeHtml(inv.date)}</td>
      <td>${escapeHtml(inv.period)}</td>
      <td>${formatMoney(inv.total)}</td>
      <td>
        <button class="btn small secondary" onclick="deleteInvoice(${idx})">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* Saved Bill Summaries table */
function renderSavedSummariesTable(){
  const tbody = document.querySelector('#saved-summaries-table tbody');
  tbody.innerHTML = '';
  (appState.summaries || []).forEach((s, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(s.id)}</td>
      <td>${escapeHtml(s.date)}</td>
      <td>${escapeHtml(s.period)}</td>
      <td>${formatMoney(s.totals && s.totals.income ? s.totals.income : 0)}</td>
      <td>
        <button class="btn small" onclick="printSavedSummary(${idx})">Print</button>
        <button class="btn small secondary" onclick="downloadSavedSummary(${idx})">Download</button>
        <button class="btn small secondary" onclick="deleteSavedSummary(${idx})">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* ---------------------------
   Computations & interactions
   --------------------------- */
function computeWorkersTotalPaid(){
  // Sum of final amount for each worker based on current production inputs and rates and adjustments
  let total = 0;
  appState.workers.forEach(w=>{
    const pounds = Number(appState.productionInputs[w.id] || 0);
    const earnings = pounds * Number(w.rate || 0);
    const finalAmount = earnings - Number(w.adjustments || 0);
    total += finalAmount;
  });
  return total;
}

/* Mohajon calculation (Calculate button) */
document.getElementById('calc-mohajon-btn').addEventListener('click', ()=>{
  const rate = parseFloat(document.getElementById('mohajon-rate').value) || 0;
  const totalProd = parseFloat(document.getElementById('mohajon-total-production').value) || 0;
  appState.mohajon.rate = rate;
  appState.mohajon.totalProduction = totalProd;
  appState.mohajon.amount = rate * totalProd;
  document.getElementById('mohajon-amount').textContent = formatMoney(appState.mohajon.amount);
  renderDashboard();
  renderBillSummary();
});

/* Restore mohajon */
document.getElementById('restore-mohajon-btn').addEventListener('click', ()=>{
  appState.mohajon = { rate:0, totalProduction:0, amount:0 };
  document.getElementById('mohajon-rate').value = '0';
  document.getElementById('mohajon-total-production').value = '0';
  document.getElementById('mohajon-amount').textContent = formatMoney(0);
  renderDashboard();
  renderBillSummary();
});

/* Weekly Calculation: pressing calculate updates table earnings & "This Week Total" */
document.getElementById('calc-weekly-btn').addEventListener('click', ()=>{
  const rows = document.querySelectorAll('#production-workers-body tr');
  let total = 0;
  rows.forEach(row=>{
    const workerId = row.querySelector('.prod-pounds').dataset.worker;
    const pounds = Number(row.querySelector('.prod-pounds').value) || 0;
    // update productionInputs model
    appState.productionInputs[workerId] = pounds;
    // read adjustment (from worker object, updated by input handler too)
    const worker = appState.workers.find(w => w.id === workerId);
    const earnings = pounds * Number(worker.rate || 0);
    const finalAmount = earnings - Number(worker.adjustments || 0);
    total += finalAmount;
    row.querySelector('.prod-earnings').textContent = formatMoney(finalAmount);
  });
  document.getElementById('this-week-total').textContent = formatMoney(total);
  // update bill summary and dashboard
  renderBillSummary();
  renderDashboard();
});

/* Restore weekly inputs: zero all worker pounds and earnings and week total (also adjustments) */
document.getElementById('restore-weekly-btn').addEventListener('click', ()=>{
  // Zero production inputs model
  appState.productionInputs = Object.fromEntries(appState.workers.map(w=>[w.id,0]));
  // Zero adjustments for each worker (persisted)
  appState.workers.forEach(w => w.adjustments = 0);

  // Update UI inputs (pounds and adjustments)
  document.querySelectorAll('.prod-pounds').forEach(inp => inp.value = '0');
  document.querySelectorAll('.prod-adjust').forEach(inp => inp.value = '0');

  // Zero earnings display
  document.querySelectorAll('.prod-earnings').forEach(td => td.textContent = formatMoney(0));
  document.getElementById('this-week-total').textContent = formatMoney(0);

  // Also ensure mohajon total production field is updated (optional)
  document.getElementById('mohajon-total-production').value = Object.values(appState.productionInputs).reduce((s,x)=>s+Number(x||0),0);

  // Re-render bill summary and dashboard
  renderBillSummary();
  renderDashboard();

  // Persist change (user expects restore to persist)
  saveState();
});

/* Rates: Set Rates button updates worker rates and saves to storage */
document.getElementById('set-rates-btn').addEventListener('click', ()=>{
  document.querySelectorAll('.rate-input').forEach(inp=>{
    const id = inp.dataset.worker;
    const val = parseFloat(inp.value) || 0;
    const w = appState.workers.find(x=>x.id===id);
    if(w) w.rate = val;
  });
  appState.ratesSavedAt = new Date().toISOString();
  saveState(); // commit rates
  // refresh production rates column
  renderProductionInputs();
});

/* Reset rates to zero */
document.getElementById('restore-rate-defaults').addEventListener('click', ()=>{
  appState.workers.forEach(w=> w.rate = 0);
  renderRatesTable();
  renderProductionInputs();
});

/* Expenses: Update only when the Update Expenses button is pressed */
document.getElementById('update-expenses-btn').addEventListener('click', ()=>{
  appState.expenses.electricity = parseFloat(document.getElementById('expense-electricity').value) || 0;
  appState.expenses.maintenance = parseFloat(document.getElementById('expense-maintenance').value) || 0;
  appState.expenses.other = parseFloat(document.getElementById('expense-other').value) || 0;
  saveState();
});

/* Restore Expenses (sets inputs to zero and saves) */
document.getElementById('restore-expenses-btn').addEventListener('click', ()=>{
  appState.expenses = { electricity: 0, maintenance: 0, other: 0 };
  document.getElementById('expense-electricity').value = Number(0).toFixed(2);
  document.getElementById('expense-maintenance').value = Number(0).toFixed(2);
  document.getElementById('expense-other').value = Number(0).toFixed(2);
  renderExpenses();
  renderDashboard();
  saveState();
});

/* Workers: Save names (applies edits across UI & state) */
document.getElementById('save-names-btn').addEventListener('click', ()=>{
  const nameCells = document.querySelectorAll('.worker-name-edit');
  nameCells.forEach(cell=>{
    const id = cell.dataset.workerId;
    const text = (cell.textContent || '').trim() || 'Unnamed';
    const w = appState.workers.find(x=>x.id===id);
    if(w) w.name = text;
  });
  saveState();
});

/* Save Bill Summary to appState.summaries (button renamed to Save Summary) */
document.getElementById('save-summary-btn').addEventListener('click', ()=>{
  // create snapshot
  const summary = {
    id: 'BS-' + Math.floor(100000 + Math.random()*900000),
    date: formatDateISO(),
    period: getWeekPeriodText(),
    company: {...(appState.company || {})},
    mohajon: { ...appState.mohajon },
    workers: [],
    expenses: { ...appState.expenses },
    totals: {}
  };

  let workersSubtotal = 0;
  appState.workers.forEach(w=>{
    const pounds = Number(appState.productionInputs[w.id] || 0);
    const earnings = pounds * Number(w.rate || 0);
    const adjustment = Number(w.adjustments || 0);
    const finalAmount = earnings - adjustment;
    workersSubtotal += finalAmount;
    summary.workers.push({ id: w.id, name: w.name, role: w.role, pounds, rate: w.rate, earnings, adjustment, finalAmount });
  });

  const expTotal = (summary.expenses.electricity||0) + (summary.expenses.maintenance||0) + (summary.expenses.other||0);
  const income = Number(summary.mohajon.amount || 0);
  const net = income - workersSubtotal - expTotal;

  summary.totals = {
    income,
    payments: workersSubtotal,
    expenses: expTotal,
    net
  };

  appState.summaries = appState.summaries || [];
  appState.summaries.unshift(summary); // newest first
  saveState();
  // go to dashboard to show saved summary
  document.querySelector('[data-page="dashboard"]').click();
});

/* Print Bill Summary: print the bill-summary card only (the card already has class printable) */
document.getElementById('print-summary-btn').addEventListener('click', ()=>{
  // ensure bill summary is rendered
  renderBillSummary();
  // print
  window.print();
});

/* Download saved summary as JSON (via blob) */
function downloadSavedSummary(index){
  const s = appState.summaries && appState.summaries[index];
  if(!s) return;
  const data = JSON.stringify(s, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${s.id || 'bill-summary'}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
window.downloadSavedSummary = downloadSavedSummary;

/* Print saved summary (renders it into printable area, then prints) */
function printSavedSummary(index){
  const s = appState.summaries && appState.summaries[index];
  if(!s) return;
  // create a simple printable HTML for the summary
  const printable = document.createElement('div');
  printable.className = 'printable';
  printable.innerHTML = `<div style="padding:18px; font-family:inherit">
    <div style="display:flex;gap:12px;align-items:center">
      <img src="${escapeHtml(s.company && s.company.logo || appState.company.logo)}" style="width:72px;height:72px;object-fit:contain" onerror="this.style.display='none'"/>
      <div>
        <h2 style="margin:0">${escapeHtml(s.company && s.company.name || appState.company.name)}</h2>
        <div class="muted-small">${escapeHtml(s.company && s.company.address || appState.company.address)}</div>
        <div class="muted-small">Phone: ${escapeHtml(s.company && s.company.phone || appState.company.phone)} — Email: ${escapeHtml(s.company && s.company.email || appState.company.email)}</div>
      </div>
    </div>
    <div class="muted-small" style="margin-top:8px">Bill Summary - ${escapeHtml(s.id)}</div>
    <div class="muted-small">Date: ${escapeHtml(s.date)} | Period: ${escapeHtml(s.period)}</div>
    <h3>Mohajon</h3>
    <table><thead><tr><th>Rate</th><th>Total Production</th><th>Total</th></tr></thead>
      <tbody><tr><td>${formatMoney(s.mohajon.rate)}</td><td>${Number(s.mohajon.totalProduction).toFixed(2)}</td><td>${formatMoney(s.mohajon.amount)}</td></tr></tbody></table>
    <h3>Workers</h3>
    <table><thead><tr><th>Worker</th><th>Role</th><th>Pounds</th><th>Rate</th><th>Final</th></tr></thead><tbody>
    ${s.workers.map(w => `<tr><td>${escapeHtml(w.name)}</td><td>${escapeHtml(w.role)}</td><td>${w.pounds}</td><td>${formatMoney(w.rate)}</td><td>${formatMoney(w.finalAmount)}</td></tr>`).join('')}
    </tbody></table>
    <h3>Expenses</h3>
    <table><thead><tr><th>Electricity</th><th>Maintenance</th><th>Other</th><th>Total</th></tr></thead>
      <tbody><tr><td>${formatMoney(s.expenses.electricity)}</td><td>${formatMoney(s.expenses.maintenance)}</td><td>${formatMoney(s.expenses.other)}</td><td>${formatMoney(s.totals.expenses)}</td></tr></tbody></table>
    <h3>Totals</h3>
    <table><thead><tr><th>Income</th><th>Payments</th><th>Expenses</th><th>Net</th></tr></thead>
      <tbody><tr><td>${formatMoney(s.totals.income)}</td><td>${formatMoney(s.totals.payments)}</td><td>${formatMoney(s.totals.expenses)}</td><td>${formatMoney(s.totals.net)}</td></tr></tbody></table>
    </div>`;
  document.body.appendChild(printable);
  window.print();
  printable.remove();
}
window.printSavedSummary = printSavedSummary;

/* Delete saved summary (requires configured password) */
function deleteSavedSummary(index){
  const password = prompt('Enter delete password to remove this saved summary:');
  if(password !== (appState.deletePassword || '1234')) { alert('Incorrect password. Deletion cancelled.'); return; }
  if(!confirm('Delete this saved summary?')) return;
  appState.summaries.splice(index,1);
  saveState();
}
window.deleteSavedSummary = deleteSavedSummary;

/* Switch to bill summary from production */
document.getElementById('switch-to-billsummary').addEventListener('click', ()=>{
  document.querySelector('[data-page="bill-summary"]').click();
});

/* Delete invoice - requires configured password */
function deleteInvoice(index){
  const password = prompt('Enter delete password to remove this invoice:');
  if(password !== (appState.deletePassword || '1234')) { alert('Incorrect password. Deletion cancelled.'); return; }
  if(!confirm('Delete this invoice?')) return;
  appState.invoices.splice(index,1);
  saveState();
}
window.deleteInvoice = deleteInvoice;

/* Delete worker history entry - requires configured password */
function deleteWorkerHistory(workerId, histIndex){
  const password = prompt('Enter delete password to remove this history entry:');
  if(password !== (appState.deletePassword || '1234')) { alert('Incorrect password. Deletion cancelled.'); return; }
  if(!confirm('Delete this history entry?')) return;
  appState.billingHistory[workerId].splice(histIndex,1);
  saveState();
}
window.deleteWorkerHistory = deleteWorkerHistory;

/* Print single worker's saved weekly invoice (from billing history) */
/* Prints only the selected worker record (weekly). Includes company header and unique invoice number. */
function printWorkerInvoice(workerId, historyIndex){
  const hist = (appState.billingHistory[workerId] || [])[historyIndex];
  if(!hist) return;
  const worker = appState.workers.find(w => w.id === workerId) || { name: 'Worker' };
  const invoiceId = generateShortId('INV');
  const printable = document.createElement('div');
  printable.className = 'printable';
  printable.style.padding = '18px';
  printable.innerHTML = `
    <div style="font-family:inherit">
      <div style="display:flex;gap:12px;align-items:center">
        <img src="${escapeHtml(appState.company && appState.company.logo)}" style="width:72px;height:72px;object-fit:contain" onerror="this.style.display='none'"/>
        <div>
          <h2 style="margin:0">${escapeHtml(appState.company && appState.company.name)}</h2>
          <div class="muted-small">${escapeHtml(appState.company && appState.company.address)}</div>
          <div class="muted-small">Phone: ${escapeHtml(appState.company && appState.company.phone)} — Email: ${escapeHtml(appState.company && appState.company.email)}</div>
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="muted-small">Invoice: <strong>${escapeHtml(invoiceId)}</strong></div>
        <div class="muted-small">Worker: <strong>${escapeHtml(worker.name)}</strong></div>
        <div class="muted-small">Date: ${escapeHtml(hist.date)}</div>
      </div>

      <table style="margin-top:12px">
        <thead><tr><th>Description</th><th>Value</th></tr></thead>
        <tbody>
          <tr><td>Pounds</td><td>${hist.pounds}</td></tr>
          <tr><td>Earnings</td><td>${formatMoney(hist.earnings)}</td></tr>
          <tr><td>Adjustment</td><td>${formatMoney(hist.adjustments)}</td></tr>
          <tr><th>Total</th><th>${formatMoney(hist.total)}</th></tr>
        </tbody>
      </table>

      <div style="margin-top:36px">
        <div style="width:300px">
          <div style="border-top:1px solid #000; margin-top:48px;"></div>
          <div class="muted-small">Receiver Signature</div>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(printable);
  window.print();
  printable.remove();
}
window.printWorkerInvoice = printWorkerInvoice;

/* ---------------------------
   Settings form handling
   --------------------------- */
function populateSettingsForm(){
  const c = appState.company || {};
  document.getElementById('setting-company-name').value = c.name || '';
  document.getElementById('setting-company-address').value = c.address || '';
  document.getElementById('setting-company-phone').value = c.phone || '';
  document.getElementById('setting-company-email').value = c.email || '';
  document.getElementById('setting-company-logo-path').value = c.logo || '';
  document.getElementById('settings-logo-preview').src = c.logo || '';
  document.getElementById('settings-current-logo-path').textContent = c.logo || '';
  // clear file input
  document.getElementById('setting-company-logo-file').value = '';
  // clear password fields
  document.getElementById('setting-delete-password-current').value = '';
  document.getElementById('setting-delete-password-new').value = '';
}

/* handle logo file upload -> convert to dataURL and update preview */
document.getElementById('setting-company-logo-file').addEventListener('change', (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = function(ev){
    const dataUrl = ev.target.result;
    document.getElementById('settings-logo-preview').src = dataUrl;
    document.getElementById('setting-company-logo-path').value = dataUrl;
  };
  reader.readAsDataURL(f);
});

/* Save settings button */
document.getElementById('save-settings-btn').addEventListener('click', ()=>{
  const currentCheck = document.getElementById('setting-delete-password-current').value || '';
  const newPass = (document.getElementById('setting-delete-password-new').value || '').trim();

  // If user attempts to change password, require matching current
  if(newPass){
    if(currentCheck !== (appState.deletePassword || '1234')){
      alert('Current password does not match. Cannot change delete password.');
      return;
    }
    appState.deletePassword = newPass;
    alert('Delete password updated.');
  }

  // apply company info
  const name = document.getElementById('setting-company-name').value || '';
  const address = document.getElementById('setting-company-address').value || '';
  const phone = document.getElementById('setting-company-phone').value || '';
  const email = document.getElementById('setting-company-email').value || '';
  const logoPath = document.getElementById('setting-company-logo-path').value || '';

  appState.company = appState.company || {};
  appState.company.name = name;
  appState.company.address = address;
  appState.company.phone = phone;
  appState.company.email = email;
  if(logoPath) appState.company.logo = logoPath;

  // apply immediately
  applyCompanyHeader();
  saveState();
  alert('Settings saved.');
});

/* Reset app default button */
document.getElementById('reset-defaults-btn').addEventListener('click', ()=>{
  resetStateToDefaults();
});

/* ---------------------------
   Small helpers + security
   --------------------------- */
function escapeHtml(str){
  if(!str && str !== 0) return '';
  return String(str)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}

/* ---------------------------
   Initialization
   --------------------------- */
function init(){
  if(!appState) appState = defaultState();
  appState.workers = appState.workers || defaultState().workers;
  appState.productionInputs = appState.productionInputs || defaultState().productionInputs;
  appState.mohajon = appState.mohajon || defaultState().mohajon;
  appState.expenses = appState.expenses || defaultState().expenses;
  appState.invoices = appState.invoices || [];
  appState.billingHistory = appState.billingHistory || defaultState().billingHistory;
  appState.summaries = appState.summaries || [];
  appState.company = appState.company || defaultState().company;
  if(!appState.deletePassword) appState.deletePassword = defaultState().deletePassword;

  document.getElementById('mohajon-rate').value = Number(appState.mohajon.rate || 0).toFixed(2);
  document.getElementById('mohajon-total-production').value = Number(appState.mohajon.totalProduction || 0).toFixed(2);
  document.getElementById('mohajon-amount').textContent = formatMoney(appState.mohajon.amount || 0);

  // initialize production total
  const totalProd = Object.values(appState.productionInputs).reduce((s,x)=>s+Number(x||0),0);
  document.getElementById('mohajon-total-production').value = Number(totalProd).toFixed(2);

  applyCompanyHeader();
  renderAll();
}

/* Generate friendly id */
function generateShortId(prefix='ID'){
  return prefix + '-' + Math.floor(100000 + Math.random()*900000);
}

// On page load
document.addEventListener('DOMContentLoaded',()=>{
  init();
});

// Expose delete functions to window
renderAll();
</script>
</body>
</html>
